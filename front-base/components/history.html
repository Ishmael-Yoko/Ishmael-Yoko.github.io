<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>History API | It&#39;s Time</title>
    <meta name="description" content="人生是一场马拉松，要适应失败，并且永不放弃">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.a0ada997.css" as="style"><link rel="preload" href="/assets/js/app.85ad02d9.js" as="script"><link rel="preload" href="/assets/js/2.4db6f8f6.js" as="script"><link rel="preload" href="/assets/js/6.38fe2a42.js" as="script"><link rel="prefetch" href="/assets/js/10.673d6fe2.js"><link rel="prefetch" href="/assets/js/11.bee9a5f0.js"><link rel="prefetch" href="/assets/js/12.c1c31908.js"><link rel="prefetch" href="/assets/js/13.a0f39bfa.js"><link rel="prefetch" href="/assets/js/14.b951b27f.js"><link rel="prefetch" href="/assets/js/15.236ea3eb.js"><link rel="prefetch" href="/assets/js/16.eea1acae.js"><link rel="prefetch" href="/assets/js/17.b43d3414.js"><link rel="prefetch" href="/assets/js/18.061cc5e8.js"><link rel="prefetch" href="/assets/js/19.205f1aa8.js"><link rel="prefetch" href="/assets/js/20.47cbd327.js"><link rel="prefetch" href="/assets/js/21.4ccedca3.js"><link rel="prefetch" href="/assets/js/22.25f00f34.js"><link rel="prefetch" href="/assets/js/23.36f1af15.js"><link rel="prefetch" href="/assets/js/24.b7779d78.js"><link rel="prefetch" href="/assets/js/25.f80078f8.js"><link rel="prefetch" href="/assets/js/26.f3893f30.js"><link rel="prefetch" href="/assets/js/27.ea53483d.js"><link rel="prefetch" href="/assets/js/28.96ae3c01.js"><link rel="prefetch" href="/assets/js/29.a129d47e.js"><link rel="prefetch" href="/assets/js/3.0e086804.js"><link rel="prefetch" href="/assets/js/30.6715c623.js"><link rel="prefetch" href="/assets/js/31.09dd2c9e.js"><link rel="prefetch" href="/assets/js/32.4804bdf8.js"><link rel="prefetch" href="/assets/js/33.74405a5b.js"><link rel="prefetch" href="/assets/js/34.fb0dde90.js"><link rel="prefetch" href="/assets/js/35.a037d26c.js"><link rel="prefetch" href="/assets/js/36.5c1b7d9b.js"><link rel="prefetch" href="/assets/js/37.9ee9d9f6.js"><link rel="prefetch" href="/assets/js/38.04d4ed49.js"><link rel="prefetch" href="/assets/js/39.84a23024.js"><link rel="prefetch" href="/assets/js/4.354a36a5.js"><link rel="prefetch" href="/assets/js/40.f7ea259a.js"><link rel="prefetch" href="/assets/js/41.dde9fe68.js"><link rel="prefetch" href="/assets/js/42.67561f63.js"><link rel="prefetch" href="/assets/js/43.4ef3597e.js"><link rel="prefetch" href="/assets/js/44.b3cd4591.js"><link rel="prefetch" href="/assets/js/45.4d957cd1.js"><link rel="prefetch" href="/assets/js/46.de52d23f.js"><link rel="prefetch" href="/assets/js/47.5fdf80c7.js"><link rel="prefetch" href="/assets/js/48.48dae27e.js"><link rel="prefetch" href="/assets/js/49.7b8278ae.js"><link rel="prefetch" href="/assets/js/5.df3e9789.js"><link rel="prefetch" href="/assets/js/50.936bb6ac.js"><link rel="prefetch" href="/assets/js/51.d038d8f5.js"><link rel="prefetch" href="/assets/js/52.00fcfb54.js"><link rel="prefetch" href="/assets/js/53.43cdf610.js"><link rel="prefetch" href="/assets/js/54.046e1bbd.js"><link rel="prefetch" href="/assets/js/55.a73ffad5.js"><link rel="prefetch" href="/assets/js/56.a9a7df32.js"><link rel="prefetch" href="/assets/js/57.d3528fab.js"><link rel="prefetch" href="/assets/js/58.0176bf6d.js"><link rel="prefetch" href="/assets/js/59.42965e20.js"><link rel="prefetch" href="/assets/js/60.0d486eda.js"><link rel="prefetch" href="/assets/js/61.68a5b6cb.js"><link rel="prefetch" href="/assets/js/62.3be030c9.js"><link rel="prefetch" href="/assets/js/63.9854efe3.js"><link rel="prefetch" href="/assets/js/64.2132de91.js"><link rel="prefetch" href="/assets/js/65.803ce53b.js"><link rel="prefetch" href="/assets/js/66.b6431f81.js"><link rel="prefetch" href="/assets/js/7.b68ef3df.js"><link rel="prefetch" href="/assets/js/8.83d728f9.js"><link rel="prefetch" href="/assets/js/9.1c45e78f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a0ada997.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">It's Time</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/front-base/html/" class="nav-link">HTML&amp;HTML5</a></li><li class="dropdown-item"><!----> <a href="/front-base/css/" class="nav-link">CSS&amp;CSS3</a></li><li class="dropdown-item"><!----> <a href="/front-base/javascript/" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/front-base/ecmascript/" class="nav-link">ES6&amp;ES7&amp;ES8</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端框架</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/front-frame/jquery/" class="nav-link">jQuery</a></li><li class="dropdown-item"><!----> <a href="/front-frame/vue/" class="nav-link">Vue</a></li><li class="dropdown-item"><!----> <a href="/front-frame/react/" class="nav-link">React</a></li><li class="dropdown-item"><!----> <a href="/front-frame/data-stream/" class="nav-link">Redux/Vuex</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">浏览器</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/browser/parts/" class="nav-link">浏览器组成</a></li><li class="dropdown-item"><!----> <a href="/browser/javascript/" class="nav-link">浏览器中的JavaScript</a></li><li class="dropdown-item"><!----> <a href="/browser/v8/" class="nav-link">V8引擎</a></li><li class="dropdown-item"><!----> <a href="/browser/event-loop/" class="nav-link">浏览器的页面循环</a></li><li class="dropdown-item"><!----> <a href="/browser/render/" class="nav-link">浏览器的渲染</a></li><li class="dropdown-item"><!----> <a href="/browser/http/" class="nav-link">HTTP1.1/HTTP2.0</a></li><li class="dropdown-item"><!----> <a href="/browser/cache/" class="nav-link">浏览器的缓存</a></li><li class="dropdown-item"><!----> <a href="/browser/security/" class="nav-link">浏览器的安全</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端工程化</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/engineering/summary/" class="nav-link">工程化概述</a></li><li class="dropdown-item"><!----> <a href="/engineering/build-tools/" class="nav-link">构建工具（webpack）</a></li><li class="dropdown-item"><!----> <a href="/engineering/compile/" class="nav-link">编译工具（babel）</a></li><li class="dropdown-item"><!----> <a href="/engineering/specification/" class="nav-link">规范化工具（ESLint）</a></li><li class="dropdown-item"><!----> <a href="/engineering/auto-deploy/" class="nav-link">自动化部署（Jekins/Travis）</a></li><li class="dropdown-item"><!----> <a href="/engineering/docker/" class="nav-link">容器化（docker）</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Node</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nodejs/summary/" class="nav-link">Node简述</a></li><li class="dropdown-item"><!----> <a href="/nodejs/string/" class="nav-link">string字符串</a></li><li class="dropdown-item"><!----> <a href="/nodejs/buffer/" class="nav-link">buffer</a></li><li class="dropdown-item"><!----> <a href="/nodejs/events/" class="nav-link">envents</a></li><li class="dropdown-item"><!----> <a href="/nodejs/stream/" class="nav-link">stream流</a></li><li class="dropdown-item"><!----> <a href="/nodejs/fs/" class="nav-link">fs文件系统</a></li><li class="dropdown-item"><!----> <a href="/nodejs/http/" class="nav-link">http网络</a></li><li class="dropdown-item"><!----> <a href="/nodejs/process/" class="nav-link">进程process</a></li><li class="dropdown-item"><!----> <a href="/nodejs/abnormal/" class="nav-link">异常处理</a></li><li class="dropdown-item"><!----> <a href="/nodejs/express/" class="nav-link">Express框架</a></li><li class="dropdown-item"><!----> <a href="/nodejs/koa2/" class="nav-link">Koa2框架</a></li><li class="dropdown-item"><!----> <a href="/nodejs/egg/" class="nav-link">eggjs框架</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">APP/Desktop</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/application/reactnative/" class="nav-link">ReactNative</a></li><li class="dropdown-item"><!----> <a href="/application/Flutter/" class="nav-link">Flutter</a></li><li class="dropdown-item"><!----> <a href="/application/eletron/" class="nav-link">Electron</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">数据结构/算法</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/datastructor/design/" class="nav-link">设计模式</a></li><li class="dropdown-item"><!----> <a href="/datastructor/data/" class="nav-link">数据结构</a></li><li class="dropdown-item"><!----> <a href="/datastructor/algorithm/" class="nav-link">算法</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/database/redis/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/database/MySql/" class="nav-link">MySql</a></li><li class="dropdown-item"><!----> <a href="/database/SQLinNode/" class="nav-link">Node中的使用</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">服务器</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/server/linux/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/server/nginx/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/server/docker/" class="nav-link">Docker</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">大杂烩</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/dazahui/skill/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/dazahui/problem/" class="nav-link">常见问题整理</a></li><li class="dropdown-item"><!----> <a href="/dazahui/tools/" class="nav-link">常用工具汇总</a></li><li class="dropdown-item"><!----> <a href="/dazahui/someword/" class="nav-link">只言片语</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端基础</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/front-base/html/" class="nav-link">HTML&amp;HTML5</a></li><li class="dropdown-item"><!----> <a href="/front-base/css/" class="nav-link">CSS&amp;CSS3</a></li><li class="dropdown-item"><!----> <a href="/front-base/javascript/" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/front-base/ecmascript/" class="nav-link">ES6&amp;ES7&amp;ES8</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端框架</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/front-frame/jquery/" class="nav-link">jQuery</a></li><li class="dropdown-item"><!----> <a href="/front-frame/vue/" class="nav-link">Vue</a></li><li class="dropdown-item"><!----> <a href="/front-frame/react/" class="nav-link">React</a></li><li class="dropdown-item"><!----> <a href="/front-frame/data-stream/" class="nav-link">Redux/Vuex</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">浏览器</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/browser/parts/" class="nav-link">浏览器组成</a></li><li class="dropdown-item"><!----> <a href="/browser/javascript/" class="nav-link">浏览器中的JavaScript</a></li><li class="dropdown-item"><!----> <a href="/browser/v8/" class="nav-link">V8引擎</a></li><li class="dropdown-item"><!----> <a href="/browser/event-loop/" class="nav-link">浏览器的页面循环</a></li><li class="dropdown-item"><!----> <a href="/browser/render/" class="nav-link">浏览器的渲染</a></li><li class="dropdown-item"><!----> <a href="/browser/http/" class="nav-link">HTTP1.1/HTTP2.0</a></li><li class="dropdown-item"><!----> <a href="/browser/cache/" class="nav-link">浏览器的缓存</a></li><li class="dropdown-item"><!----> <a href="/browser/security/" class="nav-link">浏览器的安全</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端工程化</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/engineering/summary/" class="nav-link">工程化概述</a></li><li class="dropdown-item"><!----> <a href="/engineering/build-tools/" class="nav-link">构建工具（webpack）</a></li><li class="dropdown-item"><!----> <a href="/engineering/compile/" class="nav-link">编译工具（babel）</a></li><li class="dropdown-item"><!----> <a href="/engineering/specification/" class="nav-link">规范化工具（ESLint）</a></li><li class="dropdown-item"><!----> <a href="/engineering/auto-deploy/" class="nav-link">自动化部署（Jekins/Travis）</a></li><li class="dropdown-item"><!----> <a href="/engineering/docker/" class="nav-link">容器化（docker）</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Node</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nodejs/summary/" class="nav-link">Node简述</a></li><li class="dropdown-item"><!----> <a href="/nodejs/string/" class="nav-link">string字符串</a></li><li class="dropdown-item"><!----> <a href="/nodejs/buffer/" class="nav-link">buffer</a></li><li class="dropdown-item"><!----> <a href="/nodejs/events/" class="nav-link">envents</a></li><li class="dropdown-item"><!----> <a href="/nodejs/stream/" class="nav-link">stream流</a></li><li class="dropdown-item"><!----> <a href="/nodejs/fs/" class="nav-link">fs文件系统</a></li><li class="dropdown-item"><!----> <a href="/nodejs/http/" class="nav-link">http网络</a></li><li class="dropdown-item"><!----> <a href="/nodejs/process/" class="nav-link">进程process</a></li><li class="dropdown-item"><!----> <a href="/nodejs/abnormal/" class="nav-link">异常处理</a></li><li class="dropdown-item"><!----> <a href="/nodejs/express/" class="nav-link">Express框架</a></li><li class="dropdown-item"><!----> <a href="/nodejs/koa2/" class="nav-link">Koa2框架</a></li><li class="dropdown-item"><!----> <a href="/nodejs/egg/" class="nav-link">eggjs框架</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">APP/Desktop</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/application/reactnative/" class="nav-link">ReactNative</a></li><li class="dropdown-item"><!----> <a href="/application/Flutter/" class="nav-link">Flutter</a></li><li class="dropdown-item"><!----> <a href="/application/eletron/" class="nav-link">Electron</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">数据结构/算法</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/datastructor/design/" class="nav-link">设计模式</a></li><li class="dropdown-item"><!----> <a href="/datastructor/data/" class="nav-link">数据结构</a></li><li class="dropdown-item"><!----> <a href="/datastructor/algorithm/" class="nav-link">算法</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/database/redis/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/database/MySql/" class="nav-link">MySql</a></li><li class="dropdown-item"><!----> <a href="/database/SQLinNode/" class="nav-link">Node中的使用</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">服务器</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/server/linux/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/server/nginx/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/server/docker/" class="nav-link">Docker</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">大杂烩</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/dazahui/skill/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/dazahui/problem/" class="nav-link">常见问题整理</a></li><li class="dropdown-item"><!----> <a href="/dazahui/tools/" class="nav-link">常用工具汇总</a></li><li class="dropdown-item"><!----> <a href="/dazahui/someword/" class="nav-link">只言片语</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>History API</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/front-base/components/history.html#history-api" class="sidebar-link">History API</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/front-base/components/history.html#hashhistory" class="sidebar-link">HashHistory</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/front-base/components/history.html#vue-router的路由实现以及源码分析" class="sidebar-link">Vue-Router的路由实现以及源码分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-base/components/history.html#实现原理" class="sidebar-link">实现原理</a></li><li class="sidebar-sub-header"><a href="/front-base/components/history.html#源码分析" class="sidebar-link">源码分析</a></li></ul></li><li><a href="/front-base/components/history.html#react-router的路由实现以及源码分析" class="sidebar-link">React-Router的路由实现以及源码分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-base/components/history.html#实现原理-2" class="sidebar-link">实现原理</a></li><li class="sidebar-sub-header"><a href="/front-base/components/history.html#源码分析-2" class="sidebar-link">源码分析</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="history-api"><a href="#history-api" aria-hidden="true" class="header-anchor">#</a> History API</h2> <p><code>history API</code>指的是浏览器<code>window</code>对象上的<code>history</code>属性对外提供的一些属性和方法，我们来看看都有哪些属性和方法：</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>history<span class="token punctuation">)</span>

<span class="token comment">// 返回值如下：</span>
<span class="token comment">// {</span>
<span class="token comment">//   length: 1, 该值表示当前会话历史中元数据的数目。最小为1</span>
<span class="token comment">//   scrollRestoration: 'auto', 自动设置滚动或者恢复的行为。auto 为自动，manual 为手动。默认为自动</span>
<span class="token comment">//   state: null, 返回的是一个会话历史堆栈[顶部]状态的值。这是一种可以不必等待popstate时间查看状态的方式。</span>
<span class="token comment">//   __proto___: {</span>
<span class="token comment">//     back() {}, 前往上一页，如果没有上一页则不进行任何操作</span>
<span class="token comment">//     forward() {}, 前往下一页，如果没有下一页则不进行任何操作</span>
<span class="token comment">//     go() {}, 通过当前页面的相对位置从浏览器历史记录( 会话记录 )加载页面。history.go(-1) 上一页。history.go(1) 下一页。</span>
<span class="token comment">//     length: 3,</span>
<span class="token comment">//     scrollRestoration: 'auto',</span>
<span class="token comment">//     state: null,</span>
<span class="token comment">//     pushState() {}, 按指定的名称和URL将数据push进会话历史栈中。改变当前页面的URL。但是无需重新加载页面</span>
<span class="token comment">//     replaceState() {}， 按指定的数据，名称和URL(如果提供该参数)，更新历史栈上最新的入口</span>
<span class="token comment">//   }</span>
<span class="token comment">// }</span>
</code></pre></div><p>通过以上的代码注释，可以看到。<code>history API</code>对外提供了<code>back</code>,<code>forward</code>,<code>go</code>方法，使用会话历史中的数据，进行页面的跳转。也有<code>state</code>，表示当前会话历史栈中顶部状态的值。而对会话历史栈顶部操作的就是<code>pushState</code>和<code>replaceState</code>方法，我们来看下这个方法和<code>state</code>有什么联系。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> state1 <span class="token operator">=</span> <span class="token punctuation">{</span>
  foo<span class="token punctuation">:</span> <span class="token string">'bar'</span>
<span class="token punctuation">}</span>
history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span>state1<span class="token punctuation">,</span> <span class="token string">'page 1'</span><span class="token punctuation">,</span> <span class="token string">'bar.html'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> state2 <span class="token operator">=</span> <span class="token punctuation">{</span>
  poo<span class="token punctuation">:</span> <span class="token string">'bas'</span>
<span class="token punctuation">}</span>
history<span class="token punctuation">.</span><span class="token function">replaceState</span><span class="token punctuation">(</span>state2<span class="token punctuation">,</span> <span class="token string">'page 2'</span><span class="token punctuation">,</span> <span class="token string">'bas.html'</span><span class="token punctuation">)</span>
</code></pre></div><p><code>pushState()</code>需要三个参数:</p> <ul><li>一个状态对象（一个可被序列化的任何变量。它和url对应，当用户无论什么时候导航到新状态，popstate事件就会触发，该事件的state属性会包含该历史记录条目状态对象的副本）</li> <li>一个标题（一般为空字符串）</li> <li>一个URL（该参数定义了新的历史URL记录，调用pushState之后，浏览器不会立即加载这个url，但是可能在以后的某些情况及阿紫啊这个URL。比如用户重新打开浏览器。url必须和当前URL同源）</li></ul> <p><code>replaceState()</code>需要三个参数:</p> <ul><li>一个新的状态对象（一个可被序列化的任何变量。它和url对应，当用户无论什么时候导航到新状态，popstate事件就会触发，该事件的state属性会包含该历史记录条目状态对象的副本）</li> <li>一个标题（一般为空字符串）</li> <li>一个URL（替换当前url为新的url。在历史会话中也会替换掉）</li></ul> <p><code>popstate</code>: 当活动历史记录条目更改时。触发<code>popstate</code>事件。如果被激活的历史条目是通过<code>pushState</code>创建的，或收到<code>replaceState</code>影响的。<code>popstate</code>事件的<code>state</code>属性包含历史条目的状态对象的副本。当前<code>history.state</code>为当前历史条目的状态对象副本。</p> <div class="warning custom-block"><p class="custom-block-title">注意</p> <p>调用<code>pushState</code>或者<code>replaceState</code>会发触发<code>popstate</code>事件。只有在做出浏览器动作时。才会触发该事件，如用户点击浏览器的回退按钮，或者执行<code>history.back</code>方法</p></div> <p>代码示例：</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'popstate'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'location:'</span> <span class="token operator">+</span> document<span class="token punctuation">.</span>location <span class="token operator">+</span> <span class="token string">', state:'</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// window.onpopstate = (e) =&gt; {</span>
<span class="token comment">//   console.log('location:' + document.location + ', state:' + JSON.stringify(e.state))</span>
<span class="token comment">// }</span>

history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>page<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;title 1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;?page=1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>page<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;title 2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;?page=2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
history<span class="token punctuation">.</span><span class="token function">replaceState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>page<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;title 3&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;?page=3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
history<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;location: http://example.com/example.html?page=1, state: {&quot;page&quot;:1}&quot;</span>
history<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;location: http://example.com/example.html, state: null</span>
history<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// &quot;location: http://example.com/example.html?page=3, state: {&quot;page&quot;:3}</span>
</code></pre></div><div class="warning custom-block"><p class="custom-block-title">注意</p> <p>虽然原始的历史项中没有关联的状态对象，但是后面调用<code>history.back()</code>激活改历史项的时候，也会触发<code>popstate</code>事件</p></div> <h2 id="hashhistory"><a href="#hashhistory" aria-hidden="true" class="header-anchor">#</a> HashHistory</h2> <p>当<code>URL</code>的<code>#</code>号后面的<code>URL</code>部分发生改变的时候，就会触发<code>hashchange</code>事件。</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'hashchange'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// {</span>
<span class="token comment">//   'bubbles': false, 没有触发事件冒泡</span>
<span class="token comment">//   'cancelBubble': false,没有取消事件冒泡</span>
<span class="token comment">//   'cancelable': false,没有取消</span>
<span class="token comment">//   'composed': false,</span>
<span class="token comment">//   'defaultPrevented': false, 没有浏览器默认行为</span>
<span class="token comment">//   'type': &quot;hashchange&quot;, 事件类型hashchange</span>
<span class="token comment">//   'newURL': &quot;https://juejin.im/timeline#123&quot;,新url</span>
<span class="token comment">//   'oldURL': &quot;https://juejin.im/timeline&quot;,旧url</span>
<span class="token comment">//   &quot;isTrusted&quot;: true, 当前事件是由用户行为触发，非脚本触发</span>
<span class="token comment">//   'target': window, 事件源</span>
<span class="token comment">//   'srcElement': window,</span>
<span class="token comment">//   'currentTarget': window</span>
<span class="token comment">// }</span>
</code></pre></div><h2 id="vue-router的路由实现以及源码分析"><a href="#vue-router的路由实现以及源码分析" aria-hidden="true" class="header-anchor">#</a> Vue-Router的路由实现以及源码分析</h2> <p>现在在vue/react框架盛行的时代，spa页面开发已经成为一种流行趋势。自然就少不了前端路由的实现。我们看下vue-router的实现原理和源码实现。</p> <h3 id="实现原理"><a href="#实现原理" aria-hidden="true" class="header-anchor">#</a> 实现原理</h3> <p>假如我们不知道<code>vue-router</code>的实现原理，我们根据想象一下和<code>vue</code>结合的，<code>vue-router</code>需要实现哪些功能以便于和<code>vue</code>结合。</p> <ol><li>在vue中所有页面内容都是组件，那么要想实现路由改变实现路由切换，就必然要实现组件和路由的某种连接关系。</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// vue-router 配置路由基本信息。将路由和组件实现连接</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  routes<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'/user'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> User <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ol start="2"><li>有了组件和路由的对应关系，下一步页面展示需要一个容器，所以必须有一个容器对应这个页面组件，这个组件和路由对应</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>route<span class="token operator">-</span>view<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>route<span class="token operator">-</span>view<span class="token operator">&gt;</span>
</code></pre></div><ol start="3"><li>有了容器展示，那么怎么改变路由呢？当然我们可以通过改变浏览器地址，但是对于电脑小白的人来说，他就想和点击a标签跳转链接。所以需要一个页面跳转的组件，用于跳转页面</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>route<span class="token operator">-</span>link<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>route<span class="token operator">-</span>link<span class="token operator">&gt;</span>
</code></pre></div><ol start="4"><li><p>当手动改变了路由，需要实时监听路由的变化，从而实现路由变化，页面响应。路由的监听</p></li> <li><p>前端路由的实现分为两种方式，hash 和 history，那么监听也是要区分</p></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// hash</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'hashchange'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// history</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'popstate'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ol start="6"><li>对于路由，不仅可以页面跳转，也可以代码控制跳转。还需要获取当前路由的一些基本信息</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 路由对象实例。可以调用this.$router.push 跳转页面</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>$router
<span class="token comment">// 路由实例，组件内获取，当前路由基本信息</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>$route
</code></pre></div><ol start="7"><li>路由不仅仅只对应组件，也可以传递参数，需要创建路由的匹配规则。传递参数分为query和params</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  routes<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'/user:id'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> User <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token string">'localhost:800/#/user?id=1'</span>
</code></pre></div><ol start="8"><li>路由在跳转的时候可以进行一些前置条件的判断，从而决定跳转的页面。增加路由前置守卫</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 全局前置守卫</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 完整的导航解析流程</span>
<span class="token comment">// 导航被触发。</span>
<span class="token comment">// 在失活的组件里调用离开守卫。</span>
<span class="token comment">// 调用全局的 beforeEach 守卫。</span>
<span class="token comment">// 在重用的组件里调用 beforeRouteUpdate 守卫 (2.2+)。</span>
<span class="token comment">// 在路由配置里调用 beforeEnter。</span>
<span class="token comment">// 解析异步路由组件。</span>
<span class="token comment">// 在被激活的组件里调用 beforeRouteEnter。</span>
<span class="token comment">// 调用全局的 beforeResolve 守卫 (2.5+)。</span>
<span class="token comment">// 导航被确认。</span>
<span class="token comment">// 调用全局的 afterEach 钩子。</span>
<span class="token comment">// 触发 DOM 更新。</span>
<span class="token comment">// 用创建好的实例调用 beforeRouteEnter 守卫中传给 next 的回调函数</span>
</code></pre></div><ol start="9"><li><p>路由切换的动态效果，transition</p></li> <li><p>路由的懒加载，基于ES6的import export静态分析。</p></li> <li><p>更为细节的，路由页面的滚动行为</p></li></ol> <h3 id="源码分析"><a href="#源码分析" aria-hidden="true" class="header-anchor">#</a> 源码分析</h3> <p>我们先来看一下源码的目录:<br> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQgAAAFMCAYAAAA3PyKFAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAABvpSURBVHhe7Z3vi13Hecf7tv+EXzWNY2ltHCc4q5VWu8EgF2OM5YBlanChlBQVXBcS6lc2elPiQCF60SaSUVbq1uvV2tiWsGzVthpsakkYk0CT9EVKEkpI6Iu8aEspLS1M/T3ku340mrn37v15ztmP4MM9M/PMnHOX+3zuzNk9o9/6zGd+NwEA5Nxxxx0JQQBAEQQBAFUQBABUQRAAUGWqgnj00eNpaenuYpu4774vpBMnnii2AUD7mJog7r//S2lnZyedPXu2KAnJ4dy57zYxis3bzZkzZ9LHH3/c8Oqrr+7WXb58OV29ejV98MEH6bHHvpLW17/clB2rmHwsAJiMqc4gVlZW0sWLF2+ThOWwvb3dHMc+kVOnTjVJr+SP9Ur+GzdupKeffropWw6WgoTxwgvfvKUPAEzO1O9B5JIYVQ5CArh27VqT8LFeIvBswnGaUeQiAYDpMpOblJaExLCxsTGSHIxmEVoyeCmhulwQiollAJgNMxGEWFtbbyTx0ktbI8shEpcbJUGUliIAMF1mJohJicuNXBCq0wyDexAAs6VVgvDyQsSbkrkghCXhePWN7QAwOa2dQQDA4kEQAFAFQQBAFQQBAFUQBABUQRAAUKURxG8f+7MEAJCDIACgCoIAgCoIAgCqIAgAqIIgAKAKggCAKgiiA/zFS3+Xfv3v/5n+8JsvFdsBZsVcBfEH39hMv/P7p4pt4vN/9I108lsXi237GQQBi2Juglj+k79MP/r5r9L3fvCToiQkh3/44U+bGMXm7eb3/vyv0y9//W/J//7+k/FUr+T5j//679/UpvRP//Kvu30U87Nf/Xq3n14VH8saV7FOxis3ftS06V8cy+P53//87/81fVSvMd1X9fo3qG9s0/GNH/9895r0XjTextWbTdn//H5r4wBMk7nOII7+6bfSD3/2y9skYTn8409/2RzHPhHLwUmiBNr53vdvqxdKmphMTmTH5mXHqk5tTrq8XQnr5HW8v92F2hSvfi6rj/u6TeV4jTqOslHZ1xDPURoHYFbM/R5ELolR5SCUKJoJ5IlRSpgYqyR0solB5TwZhcd/9uyl5tUJb9RXdeqjvk5yt2l8XUfeV8c+r+Nim99Tfk2lawSYBQu5SWlJSAzXf/SzkeQgYkINq1fyKMH0OqkgVCfZSBB6jQIQ6i/UJxeE2yyI/J8loPMrzv18zpIghN6z/sXZDMC0WYggxLGv/1Ujie//5BcjyUHEb9Vh9THBlHiTCMIC0lg6j8puE2pT3TBBlORiNIbiXI7XX7omU/uZAEyDhQliHJQg+sZ0IqmsexB5vYgJp1cLYFhZyah7Ae7rsS0F1cdv7Zi8oiYIH9eSeVxBDGoDmJROCUIoEZSg/ufEzetjsul4L4JQwv3gn3/xm5FuHcvx/hdloddBghA6T/zn6x8kiNhPMerjf/HGJsC06ZwgZg3fyACfgiAyEATApyCIDAQB8CkIAgCqIAgAqIIgAKBKI4jSdtfz4MSJE8V6AGgHCAIAqiAIAKiCIACgCoIAgCoIAgCq9EoQjz32lXTt2rX09NNPN+VXX321IY/LUbz6qX+pXajtgw8+SKdOnSq2A/SRVglidfWu9Nprhxt0fPz4UtreXknvv3+04cKFQ2l5+XO39InkghiVUQQBsB9plSDW1w+kt99ebXj44YPp0qUj6ebN9fTGG0fSK68cTi++uHxLfA6CAJgurRXEk0/e80nSHk3vvruaHnlk6Za4GrkgtLw4c+bM7vHGxvl09erV9PHHHzfLBQshCmJ9/ctNjNBxbWyNq3HEKMsYgC7SWkE88MCBtLl5KH300Xq6fn2tWV6oLsbnDBPEjRs3bmlzYkdBxPpIHFv3IXKBAPSR1gpCx0tLn03PP//F9M47q40orlw50tTHPpFhgvCxiEluQWxtbVUTP44dhZLHAfSJVgniwQcPNjJ4663V5ial6++8Uwl+uJlJnDx57y19InsRhGIuX768KwjNLuIMIycfW4LJlyoAfaMVgjh27GA6f/5QevPNI81M4dy55WamoN9m6Oak+PDDtfTee0fTQw8dvG0cM4kg1O/06dPVhM/HNiw3oM+0QhBPPXVPczNSv8rc3FxJa2t3NdLY2Tm8+ytO/brz8cfvvm2MyKSCUH/FWBKxviaIGBPrAfpAq5YYk5In8TiCcKyWG9/+9reLgvDyQgxalgB0nV4JYpZIEFpKWCIA+wEEMSLca4D9CIIYgpcTLCVgP4IgAKAKggCAKggCAKogCACogiAAoAqCAIAqCAIAqiAIAKiCIACgyr4RhB7AEqW2SdADYPwJNvSVVgli0l2tAWC6tEoQccu5cXa1BoDp0lpBjLOrdb7nQ3xEO2/Tsfd08NJDD2bFZUi+fFA5juE699F5tNkMD3dBX2itIMbZ1Tp/JDsmfBREHue2fM8Hb2KrsmK1wUye9BaE2hWrsWM7QJdprSB0PM6u1jHBlbhOWEuglMgWSWzTGKqTFGLZUjFxBuFzxHaALtMqQUy6q7VQkiqh9U3vLeVcHwXh5YVRndoUIzRG/moRRNTm+ji26vNYgK7RCkFMa1dr4URWgsYkjYIoLRWMxfKd75xpjl3W/8qlsfP4KAhjUZTiAbpEKwQxrV2thZcZuQQsCB3r1TMGtxv11+a0atexheKyYvKxckHkMQBdpVVLjGmh5MwFkCesynGJEb/t1SZczoUSx7IgPGvweLE/QFfppSDmiQQRxQPQJxDEBHjWwL0G6CsIYgzicoKlBPQZBAEAVRAEAFRBEABQZaGCAIB2gyAAoAqCAIAqCAIAqiAIAKiCIACgSqcE4Scta49q668a+ctGgOnRK0GMggTCw1UAozFXQTz66PG0tFTf0+G++76QTpx4otgmEATAfJmbIO6//0tpZ2cnnT17tigJyeHcue82MYrN24UFcfr06WbXaD0sVdunQbFxh+nnnnvulv0a1KYYxaqP6+Nu1D6fdpNS2+uvv96U3c99WdZAX5nrDGJlZSVdvHjxNklYDtvb281x7BNx0lsKLvtxawti0GPY+QxCMVEWkoMl4PEtgHxclQdtXwfQdeZ+DyKXxKhyEErYfIkRE752HIn1NZEoRnWl86mv+6tegtA4bgfoEwu5SWlJSAwbGxsjyUEMS9hS8mtp4LpSTGkG4DFL54tScFzsC9AnFiIIsba23kjipZe2RpKD2IsgTD5LmHQGIfQf6jz77LMsL6D3LEwQ4zCOIPL6PEbHg+5BlAQheUgOEkWsB+gbvRREXF4I1TteffWbiigF9XFsrK8JQvWKy2ceAH2jU4JoCxKEBGSRAPQVBDEGcdYC0GcQxB7w8kSzBy1jSjEAfQJBAEAVBAEAVRAEAFRBEABQBUEAQBUEAQBVEAQAVEEQAFAFQQBAlX0jCP1pdHxoq63oOvlLTWgLrRLE6upd6bXXDjfo+PjxpbS9vZLef/9ow4ULh9Ly8ueKfYcxjiBq+0VMisZDAtAFWiWI9fUD6e23VxsefvhgunTpSLp5cz298caR9Morh9OLLy4X+40CggDYO60VxJNP3pOuXTua3n13NT3yyFIxvoREUNrbwYIQbo+J7wex3O9rX/t68+pYJ7T6a6MYtcW6PK50PWq7cOFvdssil08usji22mIswKxprSAeeOBA2tw8lD76aD1dv77WLC9UV+pnlJjaot4JquRysjlRnZASgpJcr7WNYTSOkjomscaL4tGr9tWM8U5kvUZhaLt+HQ+aQURBxGOARdBaQeh4aemz6fnnv5jeeWe1EcWVK0ea+lLfEkrEQcmmsupLIhCleveJcRG1eczanpWjCmJQHMA8aJUgHnzwYCODt95abW5Suv7OO5WYh5uZxMmT997SJ0dJ5Sm5GCQIJ7OONRPwksJCGFUQKsdzqqzx1NczjciognBZYyIKWAStEMSxYwfT+fOH0ptvHmlmCufOLX+SDAea32bo5qT48MO19N57R9NDDx0sjiHyxFN5kCBUjskvlNBebowiiFJCiziO28xeBDGsHmCWtEIQTz11T3MzUr/K3NxcSWtrdzXS2Nk5vPsrTv268/HH6/+vp8iTSMcuqy3+t3pK0ngvwUQpjCKIWHa8y2qLIqjdg4jl/D0Yx+T1ALOkVUuMSXGCeqqvRHOyKfF0T8Dt+f/B6eWFiAJQYqrOCRyFkPfVmDpHbFe8x/W1xOvU+DVB6Nh9SzIDmDW9EkQfkBSiYAAWCYJoEZ5ZaEZRageYNwiiBcQlh5cXAG0AQQBAFQQBAFUQBABUQRAAUAVBAEAVBAEAVRAEAFRBEABQBUEAQJVeCWLQI9azRM9O+GGrUjtAV2mVICbd1XpRggDoK60SRNxybpxdrREEwHRprSDG2dXagtDGLN6hOp/6x/0ZYpukEne19t4LtfpI3MNB7XF/CGQFXaa1ghhnV2snZ0x8JW5M3tIO1KovzTzy+rixS4yzIDwmj2tDX2itIHS8112tS4muY9WpLcYKJbaoJXacGQiNobh8rBinV5VjO0BXaZUgJt3VuiSIPKmVvF5iCCez2r00sCjyWFFaNkRBWDaKRRTQdVohiGntal0ShI61T6QSNyayUDlP4jhGqb1EPq5guQF9oBWCmNau1p4F5N/mTvI4/c/bTExsSULj5TMGEccqCSKPAegirVpiTIq//fXf73lJEBM3LiO0VPAO1LE+XxpIFK4XHq8kCMsljwXoKr0SxKKQIKJUAPoCgpgQ7jVAn0EQYxKXEywloK8gCACogiAAoAqCAIAqCAIAqiAIAKiCIACgCoIAgCoIAgCqIAgAqIIgZoz+ypK/tISu0ipBTLqrNQBMl1YJIm45N86u1gAwXVoriHF2tRb5ng/e7EWv2itia2uradPTl5r6q6x4PXilB7AU512sRXyMW8faQ0Kx6qNzqc6xpaWE6jxG7doA2kprBTHOrtb5o9eWghLTiR8TXsnrRFfZCez++XjqGxNb9RaLyiUsiHwsgC7QWkHoeK+7WucJq1d94yuhoywcH7/dhY7zWYDGdF3eXhozJ54jPx9A22mVICbd1VrJ7Ol+RPWjCiJPYPWrbXorfM44E4nEc3gWofj8PABtpBWCmNau1vHbPmcWM4iI4krLjfwcwqJQn1gP0DZaIYhp72pdSrxRBKEY3WNw/zyRBwkijh/HLQliUD1Am2jVEmMaOMm9vPC3+iiCKPWPsskFoTbHxZuXJUHE5YWI4wC0ld4Jom1IBKUZDUAXQBAzRLMVzVo8swDoGghiBvheiJYS3GeALoMgAKAKggCAKggCAKogCACogiAAoAqCAIAqCAIAqiAIAKiCIACgSq8EMe0/bc4fzqqh8+kvJ/mTaugbrRLEpLtaL0oQAH2lVYKIW86Ns6s1ggCYLq0VxDi7WlsQp0+f3t3TIe7yJHEM2uvB9ZaCBSFKfYzG1Xl1fpVjvMbI4wG6QmsFMc6u1kpQ3QuwFFx2Ukscnl2oTm2K0XEUibE03F/lUlwUhKUS2wG6SmsFoeO97mqtBM2XGErW0re4YpXses1nACZP9lpcrK/JBqCLtEoQk+5qrQTNBaEktyDU7n0ahGcQalNi53W5IFRvqbhO5OJQP42FKKDrtEIQ09rVWglaE0TeVkv2OAMYVxAm7w/QNVohiGnual0TRJ7EEkGcLZgYN0gQUSQ1QTgm1gF0iVYtMSZFCVoThI+9vFDixmR3fdydehxBxHOUBATQJXoliEUhQfh/3yq1A3QVBDEF8pkGQF9AEBPg5QRLCegrCAIAqiAIAKiCIACgCoIAgCoIAgCqIAgAqIIgAKAKggCAKggCAKr0ShD6a8b8Ya1pMc7Y6qO/stSDXaV2gLbTKkHMelfr+ARmqX0Q+djxqU0x7rgAbaZVgohbzs1iV+tpC0LkcQB9orWCmPau1vk3vmShZFf81tZWU+e9IBwb94bIBaGnN4ctHQbNOnj6E7pAawUxi12t8xmEElcS8EzACRzLcaxcEE722tOcsc8ksxeARdFaQeh42rtalwSheCf3oHJpbBNFEutjn3xsgC7QKkHMelfrWQlC42lHqbwt76PzD5pxALSNVghiHrta63hWgqi11epZbkBXaIUg5rGrtY6nJQgdb2xsNDFC43vcWh/H5uPGeoC20aolxqSUEjIKQgmsRNY0X7LIE3VQOY6tYy0TfJOyJp3Yx8sLEX87AtBmeiWItiFBSB56LbUDtB0EMUO41wBdB0HMAC8nWEpA10EQAFAFQQBAFQQBAFUQBABUQRAAUAVBAEAVBAEAVRAEAFRBEABQZSGCOHnyZLpw4UK6774vFNunhf6KUQ9V6TU+OFWKBYDbWYggJIZz576btre3pyqJQc8+IAiAvbOwJcYsJIEgAKbLQu9B7FUSpcenvbu09nzwfgtCdZJBaW+GOCYA1Fn4TUpL4uWXX0733vv5YowZJAgd5zMIBAEwGQsXxNLS3ens2bMIAqCFLFQQlsPFixfTyspKMSaCIADmy8IEsVc5CAQBMF8WIohx5CCU+BJAFIJvSLqMIACmx0IE8cwzz6TNzb/dkxyMpSA0e4gzCAuE32IATIeF36QEgPaCIACgCoIAgCoIAgCqIAgAqIIgAKAKggCAKggCAKogCACogiAAoAqCAIAqCAIAqiCIjqOt9vTAWqltXPRgm3YD90NwsH+ZqyBWV+9Kr712uEHHx48vpe3tlfT++0cbLlw4lJaXP1fsOy+UbEq6Uts8yR9drzELQQCYuQpiff1Aevvt1YaHHz6YLl06km7eXE9vvHEkvfLK4fTii8vFfvMEQQB8ysIE8eST96Rr146md99dTY88slSMLxH3fBBKEO/1sLFxfrdOsXp1XEwi7Qlx48aN3TYlYz6uptgaV/Hq6/ph8lDs1tZW01/xKnvK7rJjY30cO1638FRfr67z9SlWY8ZrdHx+Dr1n74fhvTJ0raU+ce+M+PPyeR0L/WZhgnjggQNpc/NQ+uij9XT9+lqzvFBdqZ9xEjuR9EF94YVv7iZBTD594OM3sNrc7/Tp07sffsXFD32ME05AHfv8MZlyFOvxfF152f316mNdj9ridcXrV9njqOz3reuLCa6y++XXq7G9gY6TPr5Xo3YLIh7ncdB/FiYIHS8tfTY9//wX0zvvrDaiuHLlSFNf6iv0Ib18+XLzwY/1+Ye4lMg6jgIx6qtYvaocBVFKDrW5XbFKTuGxY/9RykbXrPfmc+l6oyDUL74fo7F8bqH+lkA+RjxHjHNfE9936WcJ+4e5CuLBBw82MnjrrdXmJqXr77xTCXC4mUmcPHnvLX0ig5K8JAgnr3GyKF7fxq6P38wxgfM4U7oGE/sPK+fXGZcAMblFlEckF4SuWf30qjHidRvVjyoIl/1zQBT7i7kI4tixg+n8+UPpzTePNDOFc+eWP/nQH2h+m6Gbk+LDD9fSe+8dTQ89dLA4hohJE+vzD/SghCp9+J1QKscEzttGYVRBWA5OuPya43vNYyPDBBHbIjrPqIIYVg/9ZS6CeOqpe5qbkfpV5ubmSlpbu6uRxs7O4d1fcerXnY8/fnexv9EHVN9kMYG9Fs8/uIpxgrlO5ImhJKrNIFyuJVmJUv9SOb9mveo6XI6CUFl94nXGexDx+lRnQQj1KYkl/zlECamuJIJBooJ+MtclxjTwhz5Ol2sfaCWO4+L0WEnlOn3gnVBq0xia6jsZnRSOj8uAEqMKQse6Ho+r69d5PHY8b+26FaO6miBU9vvJ+6l+FEHoOP6843uB/tM5QcDsySUD+xcEAbehWYRnGqV22D8gCNjFS55hyyjYPyAIAKiCIACgCoIAgCoIAgCqIAgAqIIgAKAKggCAKggCAKogCACogiBgquhhLv5Muz/MVRDsar034hOWpXaAWTNXQcQt59jVejgIAhbNwgSxH3a19lQ7P18cQ8exrFjtLPXVr/7xLfsweCyfozRWiXg9ilc57vGgsmNjfRzbP19t9uv3Ea8noj5xzL1cK7SPhQliP+xqrbKvzX3yMTR+PJ8FobjS+Sa5Hl9LXnZ/vfpY16E2vTou/3n6OiLx+uIxdJOFCULH+2FX61KSxGuJ44n4HvP3Meh61KYk9vW4T349w8pG5/YemaXz6lh1/rkZjeX3pmuIUoHuMVdB7MddrXWcJ6Cu0xLI22Ob30cUxKTXM6ic/9y8L0T+8xWqU6x/bkZjxetRWWP5Zx9jof3MRRD7eVfrPGFEFJ3aY7yua5AgJr2eWjk/V/wZ6ny5IOJ1uk5orPz9DqqHdjMXQeznXa11Pn0Tx8SLiahXX6fb8rJjxaTXUyvnP0O96ueiV7Xp2Of1dXmc+B5UV7o+x+T10G7musSYBv6wehqsD17+4Tb6oDrOsarXh9h1+tAKC8IJbWk4GRzvaXc8TyRPQOExPUZM+Di+YnQDNX4zK1ZtilHdpNczqOxzCf08dR6N7Z+vf0sk1M9jqJ+vT2O5TceOjxKG7tA5QcD8qQm4hKQQBQTdBkHAUEYVhGc3cYYE3QZBwFCGCSIue+LSA7oPggCAKggCAKogCACogiAAoAqCAIAqCAIAqiAIAKiCIACgCoIAgCqdEoT+ok8P/Yzzp7z6a7/aI+B7RWPoOqYxFkCbmasgFrmr9TQFAbBfmKsg4pZz897VGkEA7J2FCWKcXa3zh4b0YJD2KPCDQvmeA3E/AsXlglB/t/sRZb16bwPH5A8gaQxdh88Vz8PDStAnFiaIcXa1LgkibpgSkzluYqKykjjGquxYxfgx5Xici8DE+vw8AH1iYYLQ8V53tS4Jwt/8wsl64sQTu0nuNiWwZxD5OELjeCzVK1bEMUwURDzO4wC6zlwFMemu1sME4cSWIPLlRC4ILUe8LCgtD3Qcy5FcCpKI+rOtGvSNuQhiWrta70UQ+Qwi9tWx2mvJrBi1K37YDCLWK1b9Yh1Al5mLIKa5q/UogtBsQfVKVt8bULl2vyKieMvFCa+6KIWaIFwf6wC6zFyXGJOyF0G43cuH/LcYFoHbLY9cHC47+XNBSCL5GO4L0HU6JYi2IAlEEQH0FQQxBpq1xFkGQF9BEHtAYtBSgt9WwH4BQQBAFQQBAFUQBABUQRAAUAVBAEAVBAEAVRAEAFRBEABQBUEAQJVOCUJ/vai/Yiw9gj1thj0YZvwwV14P0AfmKohF7mptaomeM6ogAPrMXAURt5yb967WBkEAjM7CBDHrXa316m3ltE/Dc889d8v+D46NccISKJ2rJIhYr1idK46fxwN0iYUJYpa7WsddoWJ/x8RE985ROtY4Smy97lUQeTxAH1iYIHQ8q12tJYhhCZ3XC/XzrlN7FcQgKQF0lbkKYl67WitZnbBx2VDqE+OEZyR7FYSO1cfLFUQBfWAugpj3rtZKetfl3+yxT96m8rgziFiX9wXoKnMRxCJ2tXZdHheP8/H0OuwexCDhmDwGoKvMdYkxKaMKwv8vhpcNiosxWkb4twxKYsdpbPUbRxCK9/JC5NIA6CKdEkQbkSCYKUBfQRATkM8yAPoGghiDuJxgKQF9BkEAQBUEAQBVEAQAVEEQAFAFQQBAFQQBAFUQBABUQRAAUOWOO+5I/w8qSOUthTKBXwAAAABJRU5ErkJggg==" alt="vue-router源码目录"> <br>
这就是<code>vue-router</code>的源码结构，我我们需要关注的就是，<code>components</code>、<code>histtory</code>、<code>create-route-map.js</code>、<code>index.js</code>、<code>install.js</code>,我们就从入口分析vue-router的整个流程以及上面的功能实现：</p> <ol><li><p><code>vue-router</code> 是作为<code>vue</code>的一个插件安装到<code>vue</code>实例上。我们都知道作为<code>vue</code>的插件，必须实现一个<code>install</code>的方法(如果没有就会认为该插件本身就是个函数为<code>install</code>方法)</p></li> <li><p>我们看一下<code>vue-route</code>r的<code>install</code>方法实现:</p></li></ol> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 引入routerView 和 routerLink组件，用于后面注册到Vue上</span>
  <span class="token keyword">import</span> View <span class="token keyword">from</span> <span class="token string">'./components/view'</span>
  <span class="token keyword">import</span> Link <span class="token keyword">from</span> <span class="token string">'./components/link'</span>
  <span class="token comment">// 保存Vue构造函数，并导出</span>
  <span class="token keyword">export</span> <span class="token keyword">let</span> _Vue
  <span class="token comment">//install函数，参数为Vue构造函数</span>
  <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">install</span> <span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 只安装vue-router插件一次。如果已经安装则直接退出</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>install<span class="token punctuation">.</span>installed <span class="token operator">&amp;&amp;</span> _Vue <span class="token operator">===</span> Vue<span class="token punctuation">)</span> <span class="token keyword">return</span>
    install<span class="token punctuation">.</span>installed <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token comment">// 保存Vue构造函数为 私有对象</span>
    _Vue <span class="token operator">=</span> Vue
    <span class="token comment">// 工具函数，判断是否定义。true为定义，false为未定义</span>
    <span class="token keyword">const</span> <span class="token function-variable function">isDef</span> <span class="token operator">=</span> <span class="token parameter">v</span> <span class="token operator">=&gt;</span> v <span class="token operator">!==</span> <span class="token keyword">undefined</span>

    <span class="token keyword">const</span> <span class="token function-variable function">registerInstance</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> callVal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> i <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>_parentVnode
      <span class="token comment">// 组件初始化后，数据都存在了。然后将组件对应的路由实例route注册到组件对象上</span>
      <span class="token comment">// registerRouteInstance方法（根据路由组件对应关系，匹配是哪个组件，然后注册到对应组件实例上），改方法在components/view.js中</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>registerRouteInstance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">i</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> callVal<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// vue mixin 目的是在每一个vue组件生命周期beforeCreate之前混入$router，$route 对象</span>
    Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token function">beforeCreate</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 当前组件是否存在router </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot <span class="token operator">=</span> <span class="token keyword">this</span>
          <span class="token comment">// _router赋值。将router对象注册到vue实例上</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>_router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router
          <span class="token comment">// 路由初始化init</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
          <span class="token comment">// 定义响应式的 _route 对象</span>
          Vue<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'_route'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span>history<span class="token punctuation">.</span>current<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 没有router就是父级找，父级没有的话就用当前组件。</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$parent <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>_routerRoot<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 注册路由实例route的钩子。必须要在生命周期钩子函数beforeCreate执行</span>
        <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">destroyed</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 在注销的时候调用时因为当第二个参数为undefined时候，将会取消注册。详见components/view.js中render 方法中data.registerRouteInstance函数的注释</span>
        <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// Vue原型上注入 $router $route</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">'$router'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token keyword">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot<span class="token punctuation">.</span>_router <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">'$route'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token keyword">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot<span class="token punctuation">.</span>_route <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 注册view和link组件</span>
    Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'RouterView'</span><span class="token punctuation">,</span> View<span class="token punctuation">)</span>
    Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'RouterLink'</span><span class="token punctuation">,</span> Link<span class="token punctuation">)</span>

    <span class="token keyword">const</span> strats <span class="token operator">=</span> Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>optionMergeStrategies
    <span class="token comment">// use the same hook merging strategy for route hooks</span>
    strats<span class="token punctuation">.</span>beforeRouteEnter <span class="token operator">=</span> strats<span class="token punctuation">.</span>beforeRouteLeave <span class="token operator">=</span> strats<span class="token punctuation">.</span>beforeRouteUpdate <span class="token operator">=</span> strats<span class="token punctuation">.</span>created
  <span class="token punctuation">}</span>
</code></pre></div><ul><li>为什么需要<code>export</code>一个<code>Vue</code>引用</li></ul> <blockquote><p>因为可能在其他地方需要使用到Vue构造函数对象。如果不这样做，就需要把整个Vue包引入插件项目中去，这样就可以在使用Vue的一些方法而不用引入vue的整个包。前提是保证在install之后在使用。</p></blockquote> <ul><li>通过<code>Vue.prototype</code> 定义 <code>$router</code>、<code>$route</code> 属性就可以把他们注入到所有组件中吗？</li></ul> <blockquote><p>在<code>Vue</code>中所有的组件都是被扩展的<code>Vue</code>实例。也就是说所有组件都可以访问到这个实例原型上的属性。</p></blockquote> <ol start="3"><li>我们下来看入口文件<code>index.js</code>，我们知道<code>vue-router</code>插件需要先实例化<code>VueRouter</code>，同时传入指定的<code>options</code>对象。</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">/* @flow */</span>
  <span class="token comment">// 引入install方法</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> install <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./install'</span>
  <span class="token comment">// 起始的路径对象{path: '/'}</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">START</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./util/route'</span>
  <span class="token comment">// 断言，用来抛出vue-router执行过程中的错误</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> assert <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./util/warn'</span>
  <span class="token comment">// 判断是否是浏览器环境 typeof window !== 'undefined'</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> inBrowser <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./util/dom'</span>
  <span class="token comment">// 过滤处理路径 app//a//b =&gt; app/a/b</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> cleanPath <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./util/path'</span>
  <span class="token comment">// 创建路由的匹配规则</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> createMatcher <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./create-matcher'</span>
  <span class="token comment">// 序列化当前路由为对象形式{ _normalized, path, query, hash }</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> normalizeLocation <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./util/location'</span>
  <span class="token comment">// 是否支持pushState，这方法中包含了对移动设备的判断</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> supportsPushState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./util/push-state'</span>
  <span class="token comment">// hash 模式的路由构造函数</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> HashHistory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./history/hash'</span>
  <span class="token comment">// history 模式的路由构造函数</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> HTML5History <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./history/html5'</span>
  <span class="token comment">// 内存 模式的路由构造函数。使用数组模拟栈stack实现浏览器的历史会话栈。</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> AbstractHistory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./history/abstract'</span>
  <span class="token comment">// 匹配的路由类型约束 type 是 Macher</span>
  <span class="token keyword">import</span> type <span class="token punctuation">{</span> Matcher <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./create-matcher'</span>

  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">VueRouter</span> <span class="token punctuation">{</span>
    <span class="token comment">// 静态属性</span>
    <span class="token keyword">static</span> <span class="token function-variable function">install</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> version<span class="token punctuation">:</span> string<span class="token punctuation">;</span>

    app<span class="token punctuation">:</span> any<span class="token punctuation">;</span>
    apps<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    ready<span class="token punctuation">:</span> boolean<span class="token punctuation">;</span>
    readyCbs<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    options<span class="token punctuation">:</span> RouterOptions<span class="token punctuation">;</span>
    mode<span class="token punctuation">:</span> string<span class="token punctuation">;</span>
    history<span class="token punctuation">:</span> HashHistory <span class="token operator">|</span> HTML5History <span class="token operator">|</span> AbstractHistory<span class="token punctuation">;</span>
    matcher<span class="token punctuation">:</span> Matcher<span class="token punctuation">;</span>
    fallback<span class="token punctuation">:</span> boolean<span class="token punctuation">;</span>
    beforeHooks<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>NavigationGuard<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    resolveHooks<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>NavigationGuard<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    afterHooks<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>AfterNavigationHook<span class="token operator">&gt;</span><span class="token punctuation">;</span>

    <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">:</span> RouterOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>apps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options
      <span class="token keyword">this</span><span class="token punctuation">.</span>beforeHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>resolveHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>afterHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token comment">// 创建 match 匹配函数</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>matcher <span class="token operator">=</span> <span class="token function">createMatcher</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>routes <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token comment">// 根据 mode 实例化具体的 History</span>
      <span class="token keyword">let</span> mode <span class="token operator">=</span> options<span class="token punctuation">.</span>mode <span class="token operator">||</span> <span class="token string">'hash'</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>fallback <span class="token operator">=</span> mode <span class="token operator">===</span> <span class="token string">'history'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>supportsPushState <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>fallback <span class="token operator">!==</span> <span class="token boolean">false</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mode <span class="token operator">=</span> <span class="token string">'hash'</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inBrowser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mode <span class="token operator">=</span> <span class="token string">'abstract'</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> mode

      <span class="token keyword">switch</span> <span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">'history'</span><span class="token punctuation">:</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HTML5History</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">)</span>
          <span class="token keyword">break</span>
        <span class="token keyword">case</span> <span class="token string">'hash'</span><span class="token punctuation">:</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashHistory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fallback<span class="token punctuation">)</span>
          <span class="token keyword">break</span>
        <span class="token keyword">case</span> <span class="token string">'abstract'</span><span class="token punctuation">:</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbstractHistory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">)</span>
          <span class="token keyword">break</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">assert</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">invalid mode: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 根据传入的参数，匹配并生成路由对象</span>
    <span class="token function">match</span> <span class="token punctuation">(</span>
      raw<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span>
      current<span class="token operator">?</span><span class="token punctuation">:</span> Route<span class="token punctuation">,</span>
      redirectedFrom<span class="token operator">?</span><span class="token punctuation">:</span> Location
    <span class="token punctuation">)</span><span class="token punctuation">:</span> Route <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>matcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>raw<span class="token punctuation">,</span> current<span class="token punctuation">,</span> redirectedFrom<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">get</span> <span class="token function">currentRoute</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token operator">?</span>Route <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span>current
    <span class="token punctuation">}</span>

    <span class="token function">init</span> <span class="token punctuation">(</span>app<span class="token punctuation">:</span> any <span class="token comment">/* Vue component instance */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">assert</span><span class="token punctuation">(</span>
        install<span class="token punctuation">.</span>installed<span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">not installed. Make sure to call \`Vue.use(VueRouter)\` </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">before creating root instance.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>

      <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>

      <span class="token comment">// set up app destroyed handler</span>
      <span class="token comment">// https://github.com/vuejs/vue-router/issues/2639</span>
      app<span class="token punctuation">.</span><span class="token function">$once</span><span class="token punctuation">(</span><span class="token string">'hook:destroyed'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// clean out app from this.apps array once destroyed</span>
        <span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment">// ensure we still have a main app or null if no apps</span>
        <span class="token comment">// we do not release the router so it can be reused</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">===</span> app<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token keyword">null</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token comment">// main app previously initialized</span>
      <span class="token comment">// return as we don't need to set up new history listener</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> app

      <span class="token keyword">const</span> history <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history

      <span class="token keyword">if</span> <span class="token punctuation">(</span>history <span class="token keyword">instanceof</span> <span class="token class-name">HTML5History</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>history <span class="token keyword">instanceof</span> <span class="token class-name">HashHistory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token function-variable function">setupHashListener</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          history<span class="token punctuation">.</span><span class="token function">setupListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>
          history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          setupHashListener<span class="token punctuation">,</span>
          setupHashListener
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      history<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          app<span class="token punctuation">.</span>_route <span class="token operator">=</span> route
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">beforeEach</span> <span class="token punctuation">(</span>fn<span class="token punctuation">:</span> Function<span class="token punctuation">)</span><span class="token punctuation">:</span> Function <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">registerHook</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beforeHooks<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">beforeResolve</span> <span class="token punctuation">(</span>fn<span class="token punctuation">:</span> Function<span class="token punctuation">)</span><span class="token punctuation">:</span> Function <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">registerHook</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolveHooks<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">afterEach</span> <span class="token punctuation">(</span>fn<span class="token punctuation">:</span> Function<span class="token punctuation">)</span><span class="token punctuation">:</span> Function <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">registerHook</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>afterHooks<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">onReady</span> <span class="token punctuation">(</span><span class="token parameter">cb<span class="token punctuation">:</span> Function<span class="token punctuation">,</span> errorCb<span class="token operator">?</span><span class="token punctuation">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">onReady</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> errorCb<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">onError</span> <span class="token punctuation">(</span><span class="token parameter">errorCb<span class="token punctuation">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span>errorCb<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">push</span> <span class="token punctuation">(</span><span class="token parameter">location<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token punctuation">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// $flow-disable-line</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onComplete <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>onAbort <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> Promise <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> onComplete<span class="token punctuation">,</span> onAbort<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">replace</span> <span class="token punctuation">(</span><span class="token parameter">location<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token punctuation">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// $flow-disable-line</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onComplete <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>onAbort <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> Promise <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> onComplete<span class="token punctuation">,</span> onAbort<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">go</span> <span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">back</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">forward</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">getMatchedComponents</span> <span class="token punctuation">(</span>to<span class="token operator">?</span><span class="token punctuation">:</span> RawLocation <span class="token operator">|</span> Route<span class="token punctuation">)</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> route<span class="token punctuation">:</span> any <span class="token operator">=</span> to
        <span class="token operator">?</span> to<span class="token punctuation">.</span>matched
          <span class="token operator">?</span> to
          <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">.</span>route
        <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currentRoute
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> route<span class="token punctuation">.</span>matched<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>components<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> m<span class="token punctuation">.</span>components<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">resolve</span> <span class="token punctuation">(</span>
      to<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span>
      current<span class="token operator">?</span><span class="token punctuation">:</span> Route<span class="token punctuation">,</span>
      append<span class="token operator">?</span><span class="token punctuation">:</span> boolean
    <span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      location<span class="token punctuation">:</span> Location<span class="token punctuation">,</span>
      route<span class="token punctuation">:</span> Route<span class="token punctuation">,</span>
      href<span class="token punctuation">:</span> string<span class="token punctuation">,</span>
      <span class="token comment">// for backwards compat</span>
      normalizedTo<span class="token punctuation">:</span> Location<span class="token punctuation">,</span>
      resolved<span class="token punctuation">:</span> Route
    <span class="token punctuation">}</span> <span class="token punctuation">{</span>
      current <span class="token operator">=</span> current <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span>current
      <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token function">normalizeLocation</span><span class="token punctuation">(</span>
        to<span class="token punctuation">,</span>
        current<span class="token punctuation">,</span>
        append<span class="token punctuation">,</span>
        <span class="token keyword">this</span>
      <span class="token punctuation">)</span>
      <span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> current<span class="token punctuation">)</span>
      <span class="token keyword">const</span> fullPath <span class="token operator">=</span> route<span class="token punctuation">.</span>redirectedFrom <span class="token operator">||</span> route<span class="token punctuation">.</span>fullPath
      <span class="token keyword">const</span> base <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span>base
      <span class="token keyword">const</span> href <span class="token operator">=</span> <span class="token function">createHref</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> fullPath<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mode<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        location<span class="token punctuation">,</span>
        route<span class="token punctuation">,</span>
        href<span class="token punctuation">,</span>
        <span class="token comment">// for backwards compat</span>
        normalizedTo<span class="token punctuation">:</span> location<span class="token punctuation">,</span>
        resolved<span class="token punctuation">:</span> route
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">addRoutes</span> <span class="token punctuation">(</span><span class="token parameter">routes<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteConfig<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>matcher<span class="token punctuation">.</span><span class="token function">addRoutes</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span>current <span class="token operator">!==</span> <span class="token constant">START</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">registerHook</span> <span class="token punctuation">(</span><span class="token parameter">list<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">,</span> fn<span class="token punctuation">:</span> Function</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Function <span class="token punctuation">{</span>
    list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> i <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> list<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">createHref</span> <span class="token punctuation">(</span><span class="token parameter">base<span class="token punctuation">:</span> string<span class="token punctuation">,</span> fullPath<span class="token punctuation">:</span> string<span class="token punctuation">,</span> mode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> path <span class="token operator">=</span> mode <span class="token operator">===</span> <span class="token string">'hash'</span> <span class="token operator">?</span> <span class="token string">'#'</span> <span class="token operator">+</span> fullPath <span class="token punctuation">:</span> fullPath
    <span class="token keyword">return</span> base <span class="token operator">?</span> <span class="token function">cleanPath</span><span class="token punctuation">(</span>base <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> path<span class="token punctuation">)</span> <span class="token punctuation">:</span> path
  <span class="token punctuation">}</span>

  VueRouter<span class="token punctuation">.</span>install <span class="token operator">=</span> install
  VueRouter<span class="token punctuation">.</span>version <span class="token operator">=</span> <span class="token string">'__VERSION__'</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>inBrowser <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>Vue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>VueRouter<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

</code></pre></div><ol start="4"><li>我们看到有一个创建 <code>match</code> 匹配函数。</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// create-matcher.js文件</span>
  <span class="token comment">/* @flow */</span>

  <span class="token keyword">import</span> type VueRouter <span class="token keyword">from</span> <span class="token string">'./index'</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> resolvePath <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./util/path'</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> assert<span class="token punctuation">,</span> warn <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./util/warn'</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> createRoute <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./util/route'</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> fillParams <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./util/params'</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> createRouteMap <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./create-route-map'</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> normalizeLocation <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./util/location'</span>

  <span class="token keyword">export</span> type Matcher <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">match</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">raw<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span> current<span class="token operator">?</span><span class="token punctuation">:</span> Route<span class="token punctuation">,</span> redirectedFrom<span class="token operator">?</span><span class="token punctuation">:</span> Location</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Route<span class="token punctuation">;</span>
    <span class="token function-variable function">addRoutes</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">routes<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteConfig<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createMatcher</span> <span class="token punctuation">(</span>
    <span class="token parameter">routes<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteConfig<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    router<span class="token punctuation">:</span> VueRouter</span>
  <span class="token punctuation">)</span><span class="token punctuation">:</span> Matcher <span class="token punctuation">{</span>
    <span class="token comment">// 创建路由映射map</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> pathList<span class="token punctuation">,</span> pathMap<span class="token punctuation">,</span> nameMap <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createRouteMap</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span>
    <span class="token comment">// 添加新的route</span>
    <span class="token keyword">function</span> <span class="token function">addRoutes</span> <span class="token punctuation">(</span><span class="token parameter">routes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">createRouteMap</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> pathList<span class="token punctuation">,</span> pathMap<span class="token punctuation">,</span> nameMap<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 匹配函数 根据传入的参数从路由map中查找</span>
    <span class="token keyword">function</span> <span class="token function">match</span> <span class="token punctuation">(</span>
      <span class="token parameter">raw<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span>
      currentRoute<span class="token operator">?</span><span class="token punctuation">:</span> Route<span class="token punctuation">,</span>
      redirectedFrom<span class="token operator">?</span><span class="token punctuation">:</span> Location</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span> Route <span class="token punctuation">{</span>
      <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token function">normalizeLocation</span><span class="token punctuation">(</span>raw<span class="token punctuation">,</span> currentRoute<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> router<span class="token punctuation">)</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> location

      <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> record <span class="token operator">=</span> nameMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">warn</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Route with name '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' does not exist</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>record<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> location<span class="token punctuation">)</span>
        <span class="token keyword">const</span> paramNames <span class="token operator">=</span> record<span class="token punctuation">.</span>regex<span class="token punctuation">.</span>keys
          <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>key<span class="token punctuation">.</span>optional<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> key<span class="token punctuation">.</span>name<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> location<span class="token punctuation">.</span>params <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          location<span class="token punctuation">.</span>params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentRoute <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> currentRoute<span class="token punctuation">.</span>params <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> currentRoute<span class="token punctuation">.</span>params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> location<span class="token punctuation">.</span>params<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> paramNames<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              location<span class="token punctuation">.</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> currentRoute<span class="token punctuation">.</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        location<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token function">fillParams</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>path<span class="token punctuation">,</span> location<span class="token punctuation">.</span>params<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">named route &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> location<span class="token punctuation">,</span> redirectedFrom<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>location<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        location<span class="token punctuation">.</span>params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pathList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> path <span class="token operator">=</span> pathList<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
          <span class="token keyword">const</span> record <span class="token operator">=</span> pathMap<span class="token punctuation">[</span>path<span class="token punctuation">]</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">matchRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>regex<span class="token punctuation">,</span> location<span class="token punctuation">.</span>path<span class="token punctuation">,</span> location<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> location<span class="token punctuation">,</span> redirectedFrom<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// no match</span>
      <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> location<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">redirect</span> <span class="token punctuation">(</span>
      <span class="token parameter">record<span class="token punctuation">:</span> RouteRecord<span class="token punctuation">,</span>
      location<span class="token punctuation">:</span> Location</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span> Route <span class="token punctuation">{</span>
      <span class="token keyword">const</span> originalRedirect <span class="token operator">=</span> record<span class="token punctuation">.</span>redirect
      <span class="token keyword">let</span> redirect <span class="token operator">=</span> <span class="token keyword">typeof</span> originalRedirect <span class="token operator">===</span> <span class="token string">'function'</span>
        <span class="token operator">?</span> <span class="token function">originalRedirect</span><span class="token punctuation">(</span><span class="token function">createRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> location<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> router<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">:</span> originalRedirect

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> redirect <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        redirect <span class="token operator">=</span> <span class="token punctuation">{</span> path<span class="token punctuation">:</span> redirect <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>redirect <span class="token operator">||</span> <span class="token keyword">typeof</span> redirect <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">warn</span><span class="token punctuation">(</span>
            <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">invalid redirect option: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>redirect<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> location<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">const</span> re<span class="token punctuation">:</span> Object <span class="token operator">=</span> redirect
      <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> path <span class="token punctuation">}</span> <span class="token operator">=</span> re
      <span class="token keyword">let</span> <span class="token punctuation">{</span> query<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> params <span class="token punctuation">}</span> <span class="token operator">=</span> location
      query <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'query'</span><span class="token punctuation">)</span> <span class="token operator">?</span> re<span class="token punctuation">.</span>query <span class="token punctuation">:</span> query
      hash <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'hash'</span><span class="token punctuation">)</span> <span class="token operator">?</span> re<span class="token punctuation">.</span>hash <span class="token punctuation">:</span> hash
      params <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'params'</span><span class="token punctuation">)</span> <span class="token operator">?</span> re<span class="token punctuation">.</span>params <span class="token punctuation">:</span> params

      <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// resolved named direct</span>
        <span class="token keyword">const</span> targetRecord <span class="token operator">=</span> nameMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">assert</span><span class="token punctuation">(</span>targetRecord<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">redirect failed: named route &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; not found.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          _normalized<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          name<span class="token punctuation">,</span>
          query<span class="token punctuation">,</span>
          hash<span class="token punctuation">,</span>
          params
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> location<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. resolve relative redirect</span>
        <span class="token keyword">const</span> rawPath <span class="token operator">=</span> <span class="token function">resolveRecordPath</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> record<span class="token punctuation">)</span>
        <span class="token comment">// 2. resolve params</span>
        <span class="token keyword">const</span> resolvedPath <span class="token operator">=</span> <span class="token function">fillParams</span><span class="token punctuation">(</span>rawPath<span class="token punctuation">,</span> params<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">redirect route with path &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>rawPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token comment">// 3. rematch with existing query and hash</span>
        <span class="token keyword">return</span> <span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          _normalized<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          path<span class="token punctuation">:</span> resolvedPath<span class="token punctuation">,</span>
          query<span class="token punctuation">,</span>
          hash
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> location<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">warn</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">invalid redirect option: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>redirect<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> location<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">alias</span> <span class="token punctuation">(</span>
      <span class="token parameter">record<span class="token punctuation">:</span> RouteRecord<span class="token punctuation">,</span>
      location<span class="token punctuation">:</span> Location<span class="token punctuation">,</span>
      matchAs<span class="token punctuation">:</span> string</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span> Route <span class="token punctuation">{</span>
      <span class="token keyword">const</span> aliasedPath <span class="token operator">=</span> <span class="token function">fillParams</span><span class="token punctuation">(</span>matchAs<span class="token punctuation">,</span> location<span class="token punctuation">.</span>params<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">aliased route with path &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>matchAs<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> aliasedMatch <span class="token operator">=</span> <span class="token function">match</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        _normalized<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        path<span class="token punctuation">:</span> aliasedPath
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>aliasedMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> matched <span class="token operator">=</span> aliasedMatch<span class="token punctuation">.</span>matched
        <span class="token keyword">const</span> aliasedRecord <span class="token operator">=</span> matched<span class="token punctuation">[</span>matched<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
        location<span class="token punctuation">.</span>params <span class="token operator">=</span> aliasedMatch<span class="token punctuation">.</span>params
        <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span>aliasedRecord<span class="token punctuation">,</span> location<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> location<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">_createRoute</span> <span class="token punctuation">(</span>
      <span class="token parameter">record<span class="token punctuation">:</span> <span class="token operator">?</span>RouteRecord<span class="token punctuation">,</span>
      location<span class="token punctuation">:</span> Location<span class="token punctuation">,</span>
      redirectedFrom<span class="token operator">?</span><span class="token punctuation">:</span> Location</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span> Route <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>redirect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">redirect</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> redirectedFrom <span class="token operator">||</span> location<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>matchAs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">alias</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> location<span class="token punctuation">,</span> record<span class="token punctuation">.</span>matchAs<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token function">createRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> location<span class="token punctuation">,</span> redirectedFrom<span class="token punctuation">,</span> router<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      match<span class="token punctuation">,</span>
      addRoutes
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">matchRoute</span> <span class="token punctuation">(</span>
    <span class="token parameter">regex<span class="token punctuation">:</span> RouteRegExp<span class="token punctuation">,</span>
    path<span class="token punctuation">:</span> string<span class="token punctuation">,</span>
    params<span class="token punctuation">:</span> Object</span>
  <span class="token punctuation">)</span><span class="token punctuation">:</span> boolean <span class="token punctuation">{</span>
    <span class="token keyword">const</span> m <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>regex<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>m<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> len <span class="token operator">=</span> m<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> key <span class="token operator">=</span> regex<span class="token punctuation">.</span>keys<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
      <span class="token keyword">const</span> val <span class="token operator">=</span> <span class="token keyword">typeof</span> m<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">?</span> <span class="token function">decodeURIComponent</span><span class="token punctuation">(</span>m<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> m<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Fix #1994: using * with props: true generates a param named 0</span>
        params<span class="token punctuation">[</span>key<span class="token punctuation">.</span>name <span class="token operator">||</span> <span class="token string">'pathMatch'</span><span class="token punctuation">]</span> <span class="token operator">=</span> val
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">resolveRecordPath</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">:</span> string<span class="token punctuation">,</span> record<span class="token punctuation">:</span> RouteRecord</span><span class="token punctuation">)</span><span class="token punctuation">:</span> string <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">resolvePath</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> record<span class="token punctuation">.</span>parent <span class="token operator">?</span> record<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>path <span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>从上面代码我们可以看到，创建匹配函数的作用就是：首先把route创建为map映射，然后match函数根据传入的路由信息，在当前路由map中查找，匹配到了，就返回对应的路由对象信息，没有匹配到就创建当前传入路由参数的路由信息。
5. 下一步，我们看一下怎样创建路由map</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// create-route-map.js</span>
<span class="token comment">/* @flow */</span>

<span class="token keyword">import</span> Regexp <span class="token keyword">from</span> <span class="token string">'path-to-regexp'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> cleanPath <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./util/path'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> assert<span class="token punctuation">,</span> warn <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./util/warn'</span>
<span class="token comment">// 创建路由map的函数</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRouteMap</span> <span class="token punctuation">(</span>
  <span class="token parameter">routes<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteConfig<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  oldPathList<span class="token operator">?</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  oldPathMap<span class="token operator">?</span><span class="token punctuation">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  oldNameMap<span class="token operator">?</span><span class="token punctuation">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span></span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
  pathList<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  pathMap<span class="token punctuation">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  nameMap<span class="token punctuation">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span>
<span class="token punctuation">}</span> <span class="token punctuation">{</span>
  <span class="token comment">// 路由列表</span>
  <span class="token keyword">const</span> pathList<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token operator">=</span> oldPathList <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// path 路由map</span>
  <span class="token keyword">const</span> pathMap<span class="token punctuation">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span> <span class="token operator">=</span> oldPathMap <span class="token operator">||</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token comment">// name 路由map</span>
  <span class="token keyword">const</span> nameMap<span class="token punctuation">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span> <span class="token operator">=</span> oldNameMap <span class="token operator">||</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token comment">// 遍历添加路由信息到routes中</span>
  routes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">addRouteRecord</span><span class="token punctuation">(</span>pathList<span class="token punctuation">,</span> pathMap<span class="token punctuation">,</span> nameMap<span class="token punctuation">,</span> route<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 确保*在最后一个</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> pathList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pathList<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'*'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      pathList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>pathList<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      l<span class="token operator">--</span>
      i<span class="token operator">--</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    pathList<span class="token punctuation">,</span>
    pathMap<span class="token punctuation">,</span>
    nameMap
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 增加路由记录</span>
<span class="token keyword">function</span> <span class="token function">addRouteRecord</span> <span class="token punctuation">(</span>
  <span class="token parameter">pathList<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  pathMap<span class="token punctuation">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  nameMap<span class="token punctuation">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  route<span class="token punctuation">:</span> RouteConfig<span class="token punctuation">,</span>
  parent<span class="token operator">?</span><span class="token punctuation">:</span> RouteRecord<span class="token punctuation">,</span>
  matchAs<span class="token operator">?</span><span class="token punctuation">:</span> string</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取 path 、name</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> route
  <span class="token keyword">const</span> pathToRegexpOptions<span class="token punctuation">:</span> PathToRegexpOptions <span class="token operator">=</span>
    route<span class="token punctuation">.</span>pathToRegexpOptions <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">const</span> normalizedPath <span class="token operator">=</span> <span class="token function">normalizePath</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> pathToRegexpOptions<span class="token punctuation">.</span>strict<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> route<span class="token punctuation">.</span>caseSensitive <span class="token operator">===</span> <span class="token string">'boolean'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pathToRegexpOptions<span class="token punctuation">.</span>sensitive <span class="token operator">=</span> route<span class="token punctuation">.</span>caseSensitive
  <span class="token punctuation">}</span>
  <span class="token comment">// 路由记录 对象</span>
  <span class="token keyword">const</span> record<span class="token punctuation">:</span> RouteRecord <span class="token operator">=</span> <span class="token punctuation">{</span>
    path<span class="token punctuation">:</span> normalizedPath<span class="token punctuation">,</span>
    regex<span class="token punctuation">:</span> <span class="token function">compileRouteRegex</span><span class="token punctuation">(</span>normalizedPath<span class="token punctuation">,</span> pathToRegexpOptions<span class="token punctuation">)</span><span class="token punctuation">,</span>
    components<span class="token punctuation">:</span> route<span class="token punctuation">.</span>components <span class="token operator">||</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token punctuation">:</span> route<span class="token punctuation">.</span>component <span class="token punctuation">}</span><span class="token punctuation">,</span>
    instances<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    name<span class="token punctuation">,</span>
    parent<span class="token punctuation">,</span>
    matchAs<span class="token punctuation">,</span>
    redirect<span class="token punctuation">:</span> route<span class="token punctuation">.</span>redirect<span class="token punctuation">,</span>
    beforeEnter<span class="token punctuation">:</span> route<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">,</span>
    meta<span class="token punctuation">:</span> route<span class="token punctuation">.</span>meta <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    props<span class="token punctuation">:</span>
      route<span class="token punctuation">.</span>props <span class="token operator">==</span> <span class="token keyword">null</span>
        <span class="token operator">?</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">:</span> route<span class="token punctuation">.</span>components
          <span class="token operator">?</span> route<span class="token punctuation">.</span>props
          <span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token punctuation">:</span> route<span class="token punctuation">.</span>props <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 嵌套子路由 则递归增加 记录</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    route<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> childMatchAs <span class="token operator">=</span> matchAs
        <span class="token operator">?</span> <span class="token function">cleanPath</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>matchAs<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>child<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token keyword">undefined</span>
      <span class="token function">addRouteRecord</span><span class="token punctuation">(</span>pathList<span class="token punctuation">,</span> pathMap<span class="token punctuation">,</span> nameMap<span class="token punctuation">,</span> child<span class="token punctuation">,</span> record<span class="token punctuation">,</span> childMatchAs<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pathMap<span class="token punctuation">[</span>record<span class="token punctuation">.</span>path<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pathList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
    pathMap<span class="token punctuation">[</span>record<span class="token punctuation">.</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> record
  <span class="token punctuation">}</span>
  <span class="token comment">//处理别名 alias 逻辑，增加对应记录</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>alias <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> aliases <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>alias<span class="token punctuation">)</span> <span class="token operator">?</span> route<span class="token punctuation">.</span>alias <span class="token punctuation">:</span> <span class="token punctuation">[</span>route<span class="token punctuation">.</span>alias<span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> aliases<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> alias <span class="token operator">=</span> aliases<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> alias <span class="token operator">===</span> path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Found an alias with the same value as the path: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;. You have to remove that alias. It will be ignored in development.</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span>
        <span class="token comment">// skip in dev to make it work</span>
        <span class="token keyword">continue</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">const</span> aliasRoute <span class="token operator">=</span> <span class="token punctuation">{</span>
        path<span class="token punctuation">:</span> alias<span class="token punctuation">,</span>
        children<span class="token punctuation">:</span> route<span class="token punctuation">.</span>children
      <span class="token punctuation">}</span>
      <span class="token function">addRouteRecord</span><span class="token punctuation">(</span>
        pathList<span class="token punctuation">,</span>
        pathMap<span class="token punctuation">,</span>
        nameMap<span class="token punctuation">,</span>
        aliasRoute<span class="token punctuation">,</span>
        parent<span class="token punctuation">,</span>
        record<span class="token punctuation">.</span>path <span class="token operator">||</span> <span class="token string">'/'</span> <span class="token comment">// matchAs</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nameMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      nameMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> record
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>matchAs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Duplicate named routes definition: </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">{ name: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;, path: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>record<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; }</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">compileRouteRegex</span> <span class="token punctuation">(</span>
  <span class="token parameter">path<span class="token punctuation">:</span> string<span class="token punctuation">,</span>
  pathToRegexpOptions<span class="token punctuation">:</span> PathToRegexpOptions</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> RouteRegExp <span class="token punctuation">{</span>
  <span class="token keyword">const</span> regex <span class="token operator">=</span> <span class="token function">Regexp</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pathToRegexpOptions<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> keys<span class="token punctuation">:</span> any <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
    regex<span class="token punctuation">.</span>keys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token operator">!</span>keys<span class="token punctuation">[</span>key<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Duplicate param keys in route with path: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
      keys<span class="token punctuation">[</span>key<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> regex
<span class="token punctuation">}</span>
<span class="token comment">// 序列化路径对路径对象</span>
<span class="token keyword">function</span> <span class="token function">normalizePath</span> <span class="token punctuation">(</span>
  <span class="token parameter">path<span class="token punctuation">:</span> string<span class="token punctuation">,</span>
  parent<span class="token operator">?</span><span class="token punctuation">:</span> RouteRecord<span class="token punctuation">,</span>
  strict<span class="token operator">?</span><span class="token punctuation">:</span> boolean</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> string <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>strict<span class="token punctuation">)</span> path <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\/$/</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> path
  <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> path
  <span class="token keyword">return</span> <span class="token function">cleanPath</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>parent<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>以上部分我们可以看到主要流程为：根据用户路由配置对象，生成普通的根据path来对应的路由记录以及根据name来对应的路由记录的map，方便后续对应</p> <ol start="6"><li>上面我们看完了创建匹配函数，下来我们看index.js中实例不同的路由类(hashHistory Html5History AbstractHistory)他们分别自己的实现，但是我们看到以上三种类都是集成自History类，那我们看下History都提供了那些公共属性和方法呢？</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// base.js</span>
  <span class="token comment">/* @flow */</span>
  <span class="token comment">// 使用install中的Vue引用</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> _Vue <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../install'</span>
  <span class="token keyword">import</span> type Router <span class="token keyword">from</span> <span class="token string">'../index'</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> inBrowser <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/dom'</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> runQueue <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/async'</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> warn<span class="token punctuation">,</span> isError<span class="token punctuation">,</span> isExtendedError <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/warn'</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">START</span><span class="token punctuation">,</span> isSameRoute <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/route'</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span>
    flatten<span class="token punctuation">,</span>
    flatMapComponents<span class="token punctuation">,</span>
    resolveAsyncComponents
  <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/resolve-components'</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> NavigationDuplicated <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./errors'</span>

  <span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">History</span> <span class="token punctuation">{</span>
    <span class="token comment">// router</span>
    router<span class="token punctuation">:</span> Router
    <span class="token comment">// 项目根路径</span>
    base<span class="token punctuation">:</span> string
    <span class="token comment">// 当前路由对象</span>
    current<span class="token punctuation">:</span> Route
    pending<span class="token punctuation">:</span> <span class="token operator">?</span>Route
    <span class="token function-variable function">cb</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">r<span class="token punctuation">:</span> Route</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
    ready<span class="token punctuation">:</span> boolean
    readyCbs<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span>
    readyErrorCbs<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span>
    errorCbs<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span>

    <span class="token comment">// 子类（hash history abstract）要实现的方法</span>
    <span class="token operator">+</span><span class="token function-variable function">go</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">:</span> number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
    <span class="token operator">+</span><span class="token function-variable function">push</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">loc<span class="token punctuation">:</span> RawLocation</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
    <span class="token operator">+</span><span class="token function-variable function">replace</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">loc<span class="token punctuation">:</span> RawLocation</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
    <span class="token operator">+</span><span class="token function-variable function">ensureURL</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">push<span class="token operator">?</span><span class="token punctuation">:</span> boolean</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
    <span class="token operator">+</span><span class="token function-variable function">getCurrentLocation</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> string

    <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">router<span class="token punctuation">:</span> Router<span class="token punctuation">,</span> base<span class="token punctuation">:</span> <span class="token operator">?</span>string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 当前路由实例</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>router <span class="token operator">=</span> router
      <span class="token comment">// 根路径</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>base <span class="token operator">=</span> <span class="token function">normalizeBase</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span>
      <span class="token comment">// 当前路径对象</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token constant">START</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ready <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>readyCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>readyErrorCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>errorCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 路径监听方法</span>
    <span class="token function">listen</span> <span class="token punctuation">(</span><span class="token parameter">cb<span class="token punctuation">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb
    <span class="token punctuation">}</span>
    <span class="token function">onReady</span> <span class="token punctuation">(</span><span class="token parameter">cb<span class="token punctuation">:</span> Function<span class="token punctuation">,</span> errorCb<span class="token punctuation">:</span> <span class="token operator">?</span>Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>readyCbs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>errorCb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>readyErrorCbs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>errorCb<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">onError</span> <span class="token punctuation">(</span><span class="token parameter">errorCb<span class="token punctuation">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>errorCbs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>errorCb<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 路由改变之后。对应组件切换，并更新页面</span>
    <span class="token function">transitionTo</span> <span class="token punctuation">(</span>
      <span class="token parameter">location<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span>
      onComplete<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">,</span>
      onAbort<span class="token operator">?</span><span class="token punctuation">:</span> Function</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 根据当前路径匹配到路由对象</span>
      <span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">)</span>
      <span class="token comment">// 根据当前路由对象，并制定完成后的回调。用于更新组件</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">confirmTransition</span><span class="token punctuation">(</span>
        route<span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
          onComplete <span class="token operator">&amp;&amp;</span> <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

          <span class="token comment">// fire ready cbs once</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>ready <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>readyCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token function">cb</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>onAbort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">onAbort</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>ready <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>readyErrorCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 这里注册了路由导航守卫钩子</span>
    <span class="token function">confirmTransition</span> <span class="token punctuation">(</span><span class="token parameter">route<span class="token punctuation">:</span> Route<span class="token punctuation">,</span> onComplete<span class="token punctuation">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token punctuation">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current
      <span class="token keyword">const</span> <span class="token function-variable function">abort</span> <span class="token operator">=</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// after merging https://github.com/vuejs/vue-router/pull/2771 we</span>
        <span class="token comment">// When the user navigates through history through back/forward buttons</span>
        <span class="token comment">// we do not want to throw the error. We only throw it if directly calling</span>
        <span class="token comment">// push/replace. That's why it's not included in isError</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isExtendedError</span><span class="token punctuation">(</span>NavigationDuplicated<span class="token punctuation">,</span> err<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>errorCbs<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>errorCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">warn</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">'uncaught error during route navigation:'</span><span class="token punctuation">)</span>
            console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        onAbort <span class="token operator">&amp;&amp;</span> <span class="token function">onAbort</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token function">isSameRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> current<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token comment">// in the case the route map has been dynamically appended to</span>
        route<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length <span class="token operator">===</span> current<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NavigationDuplicated</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">const</span> <span class="token punctuation">{</span> updated<span class="token punctuation">,</span> deactivated<span class="token punctuation">,</span> activated <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">resolveQueue</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>matched<span class="token punctuation">,</span>
        route<span class="token punctuation">.</span>matched
      <span class="token punctuation">)</span>

      <span class="token keyword">const</span> queue<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>NavigationGuard<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
        <span class="token comment">// 组件离开的守卫</span>
        <span class="token function">extractLeaveGuards</span><span class="token punctuation">(</span>deactivated<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// 全局的before守卫</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>beforeHooks<span class="token punctuation">,</span>
        <span class="token comment">// 组件更新的守卫</span>
        <span class="token function">extractUpdateHooks</span><span class="token punctuation">(</span>updated<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// 路由独享的守卫</span>
        activated<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> m<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// 异步组件</span>
        <span class="token function">resolveAsyncComponents</span><span class="token punctuation">(</span>activated<span class="token punctuation">)</span>
      <span class="token punctuation">)</span>

      <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> route
      <span class="token keyword">const</span> <span class="token function-variable function">iterator</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">hook<span class="token punctuation">:</span> NavigationGuard<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">!==</span> route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token function">hook</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> current<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>to <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token operator">||</span> <span class="token function">isError</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// next(false) -&gt; abort navigation, ensure current URL</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
              <span class="token function">abort</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
              <span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span>
              <span class="token punctuation">(</span><span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span>
                <span class="token punctuation">(</span><span class="token keyword">typeof</span> to<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> to<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// next('/') or next({ path: '/' }) -&gt; redirect</span>
              <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> to<span class="token punctuation">.</span>replace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token comment">// confirm transition and pass on the value</span>
              <span class="token function">next</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">abort</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 执行注册导航守卫钩子函数，存在嵌套路由则递归执行注册</span>
      <span class="token function">runQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> iterator<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> postEnterCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">const</span> <span class="token function-variable function">isValid</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">===</span> route
        <span class="token comment">// wait until async components are resolved before</span>
        <span class="token comment">// extracting in-component enter guards</span>
        <span class="token keyword">const</span> enterGuards <span class="token operator">=</span> <span class="token function">extractEnterGuards</span><span class="token punctuation">(</span>activated<span class="token punctuation">,</span> postEnterCbs<span class="token punctuation">,</span> isValid<span class="token punctuation">)</span>
        <span class="token keyword">const</span> queue <span class="token operator">=</span> enterGuards<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>resolveHooks<span class="token punctuation">)</span>
        <span class="token function">runQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> iterator<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">!==</span> route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span>
          <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              postEnterCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 更新路由 其实就是更新页面对象。更新当前组件对象和路由对象</span>
    <span class="token function">updateRoute</span> <span class="token punctuation">(</span><span class="token parameter">route<span class="token punctuation">:</span> Route</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> prev <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current
      <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">=</span> route
      <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>afterHooks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">hook</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        hook <span class="token operator">&amp;&amp;</span> <span class="token function">hook</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> prev<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// // 得到 base 值</span>
  <span class="token keyword">function</span> <span class="token function">normalizeBase</span> <span class="token punctuation">(</span><span class="token parameter">base<span class="token punctuation">:</span> <span class="token operator">?</span>string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> string <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>base<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>inBrowser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// respect &lt;base&gt; tag</span>
        <span class="token keyword">const</span> baseEl <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'base'</span><span class="token punctuation">)</span>
        base <span class="token operator">=</span> <span class="token punctuation">(</span>baseEl <span class="token operator">&amp;&amp;</span> baseEl<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'href'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'/'</span>
        <span class="token comment">// strip full URL origin</span>
        base <span class="token operator">=</span> base<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/^https?:\/\/[^\/]+/</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        base <span class="token operator">=</span> <span class="token string">'/'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// make sure there's the starting slash</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>base<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      base <span class="token operator">=</span> <span class="token string">'/'</span> <span class="token operator">+</span> base
    <span class="token punctuation">}</span>
    <span class="token comment">// remove trailing slash</span>
    <span class="token keyword">return</span> base<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\/$/</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token operator">...</span>
</code></pre></div><p>从上面我们可以看到，history类主要提供了，注册路由导航守卫钩子函数的方法，对于路由切换后路由状态的更新，页面组件的切换，还有就是给子类提供了一些列的接口供子类实现。（go push replace ensureURL getCurrentLocation ）</p> <ol start="7"><li>我们之前在install方法中看到使用<code>Vue.mixin</code>混入了<code>beforeCreate</code>方法，并且在这个方法中<code>this._router.init(this)</code>,我们呢看下这个init方法干啥了</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">init</span> <span class="token punctuation">(</span>app<span class="token punctuation">:</span> any <span class="token comment">/* Vue component instance */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">assert</span><span class="token punctuation">(</span>
      install<span class="token punctuation">.</span>installed<span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">not installed. Make sure to call \`Vue.use(VueRouter)\` </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">before creating root instance.</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>

    <span class="token comment">// set up app destroyed handler</span>
    <span class="token comment">// https://github.com/vuejs/vue-router/issues/2639</span>
    app<span class="token punctuation">.</span><span class="token function">$once</span><span class="token punctuation">(</span><span class="token string">'hook:destroyed'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// clean out app from this.apps array once destroyed</span>
      <span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token comment">// ensure we still have a main app or null if no apps</span>
      <span class="token comment">// we do not release the router so it can be reused</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">===</span> app<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// main app previously initialized</span>
    <span class="token comment">// return as we don't need to set up new history listener</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> app

    <span class="token keyword">const</span> history <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history

    <span class="token keyword">if</span> <span class="token punctuation">(</span>history <span class="token keyword">instanceof</span> <span class="token class-name">HTML5History</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>history <span class="token keyword">instanceof</span> <span class="token class-name">HashHistory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token function-variable function">setupHashListener</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        history<span class="token punctuation">.</span><span class="token function">setupListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>
        history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        setupHashListener<span class="token punctuation">,</span>
        setupHashListener
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    history<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        app<span class="token punctuation">.</span>_route <span class="token operator">=</span> route
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>可以看到初始化主要就是给 <code>app</code> 赋值，针对于 <code>HTML5History</code> 和 <code>HashHistory</code> 特殊处理，因为在这两种模式下才有可能存在进入时候的不是默认页，需要根据当前浏览器地址栏里的 <code>path</code> 或者 <code>hash</code> 来激活对应的路由，此时就是通过调用 <code>transitionTo</code> 来达到目的；而且此时还有个注意点是针对于 <code>HashHistory</code> 有特殊处理，为什么不直接在初始化 <code>HashHistory</code> 的时候监听 <code>hashchange</code> 事件呢？这个是为了修复<code>vuejs/vue-router#725</code>这个 <code>bug</code> 而这样做的，简要来说就是说如果在 <code>beforeEnter</code> 这样的钩子函数中是异步的话，<code>beforeEnter</code> 钩子就会被触发两次，原因是因为在初始化的时候如果此时的 <code>hash</code> 值不是以 <code>/</code> 开头的话就会补上 <code>#/</code>，这个过程会触发 <code>hashchange</code> 事件，所以会再走一次生命周期钩子，也就意味着会再次调用 <code>beforeEnter</code> 钩子函数。</p> <p>我们看到最后调用了 history.listen 方法：</p> <div class="language-js extra-class"><pre class="language-js"><code>history<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>_route <span class="token operator">=</span> route
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>listen 方法很简单就是设置下当前历史对象的  <code>cb</code> 的值, 在之前分析 <code>transitionTo</code> 的时候已经知道在 <code>history</code> 更新完毕的时候调用下这个 <code>cb</code>。然后看这里设置的这个函数的作用就是更新下当前应用实例的 <code>_route</code> 的值，更新这个有什么用呢？请看下段落的分析。</p> <ol start="8"><li>defineReactive 定义 _route</li></ol> <p>继续回到 <code>beforeCreate</code> 钩子函数中，在最后通过 <code>Vue</code>的工具方法给当前应用实例定义了一个响应式的 <code>_route</code> 属性，值就是获取的 <code>this._router.history.current</code>，也就是当前 <code>history</code> 实例的当前活动路由对象。给应用实例定义了这么一个响应式的属性值也就意味着如果该属性值发生了变化，就会触发更新机制，继而调用应用实例的 <code>render</code> 重新渲染。还记得上一段结尾留下的疑问，也就是 <code>history</code> 每次更新成功后都会去更新应用实例的 <code>_rout</code>e 的值，也就意味着一旦 <code>history</code> 发生改变就会触发更新机制调用应用实例的 <code>render</code> 方法进行重新渲染。</p> <ol start="9"><li>router-view 组件</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">import</span> <span class="token punctuation">{</span> warn <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/warn'</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> extend <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/misc'</span>

  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">'RouterView'</span><span class="token punctuation">,</span>
    functional<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    props<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      name<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        type<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token string">'default'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">render</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> <span class="token punctuation">{</span> props<span class="token punctuation">,</span> children<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 解决嵌套深度问题</span>
      data<span class="token punctuation">.</span>routerView <span class="token operator">=</span> <span class="token boolean">true</span>

      <span class="token comment">// directly use parent context's createElement() function</span>
      <span class="token comment">// so that components rendered by router-view can resolve named slots</span>
      <span class="token keyword">const</span> h <span class="token operator">=</span> parent<span class="token punctuation">.</span>$createElement
      <span class="token keyword">const</span> name <span class="token operator">=</span> props<span class="token punctuation">.</span>name
      <span class="token comment">// route 对象</span>
      <span class="token keyword">const</span> route <span class="token operator">=</span> parent<span class="token punctuation">.</span>$route
      <span class="token comment">// 缓存</span>
      <span class="token keyword">const</span> cache <span class="token operator">=</span> parent<span class="token punctuation">.</span>_routerViewCache <span class="token operator">||</span> <span class="token punctuation">(</span>parent<span class="token punctuation">.</span>_routerViewCache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token comment">// 当前组件的深度</span>
      <span class="token keyword">let</span> depth <span class="token operator">=</span> <span class="token number">0</span>
      <span class="token keyword">let</span> inactive <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span>_routerRoot <span class="token operator">!==</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> vnodeData <span class="token operator">=</span> parent<span class="token punctuation">.</span>$vnode <span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span>$vnode<span class="token punctuation">.</span>data
        <span class="token keyword">if</span> <span class="token punctuation">(</span>vnodeData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>vnodeData<span class="token punctuation">.</span>routerView<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            depth<span class="token operator">++</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>vnodeData<span class="token punctuation">.</span>keepAlive <span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span>_inactive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            inactive <span class="token operator">=</span> <span class="token boolean">true</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        parent <span class="token operator">=</span> parent<span class="token punctuation">.</span>$parent
      <span class="token punctuation">}</span>
      data<span class="token punctuation">.</span>routerViewDepth <span class="token operator">=</span> depth

      <span class="token comment">// 处理 keepalive 逻辑</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>inactive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>cache<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 得到相匹配的当前组件层级的 路由记录</span>
      <span class="token keyword">const</span> matched <span class="token operator">=</span> route<span class="token punctuation">.</span>matched<span class="token punctuation">[</span>depth<span class="token punctuation">]</span>
      <span class="token comment">// render empty node if no matched route</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cache<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 得到要渲染组件</span>
      <span class="token keyword">const</span> component <span class="token operator">=</span> cache<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> matched<span class="token punctuation">.</span>components<span class="token punctuation">[</span>name<span class="token punctuation">]</span>

      <span class="token comment">// attach instance registration hook</span>
      <span class="token comment">// this will be called in the instance's injected lifecycle hooks</span>
      data<span class="token punctuation">.</span><span class="token function-variable function">registerRouteInstance</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// val could be undefined for unregistration</span>
        <span class="token keyword">const</span> current <span class="token operator">=</span> matched<span class="token punctuation">.</span>instances<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          <span class="token punctuation">(</span>val <span class="token operator">&amp;&amp;</span> current <span class="token operator">!==</span> vm<span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token punctuation">(</span><span class="token operator">!</span>val <span class="token operator">&amp;&amp;</span> current <span class="token operator">===</span> vm<span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          matched<span class="token punctuation">.</span>instances<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> val
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// also register instance in prepatch hook</span>
      <span class="token comment">// in case the same component instance is reused across different routes</span>
      <span class="token punctuation">;</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>hook <span class="token operator">||</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>hook <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">prepatch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        matched<span class="token punctuation">.</span>instances<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> vnode<span class="token punctuation">.</span>componentInstance
      <span class="token punctuation">}</span>

      <span class="token comment">// register instance in init hook</span>
      <span class="token comment">// in case kept-alive component be actived when routes changed</span>
      data<span class="token punctuation">.</span>hook<span class="token punctuation">.</span><span class="token function-variable function">init</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">vnode</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>keepAlive <span class="token operator">&amp;&amp;</span>
          vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">&amp;&amp;</span>
          vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">!==</span> matched<span class="token punctuation">.</span>instances<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          matched<span class="token punctuation">.</span>instances<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> vnode<span class="token punctuation">.</span>componentInstance
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// resolve props</span>
      <span class="token keyword">let</span> propsToPass <span class="token operator">=</span> data<span class="token punctuation">.</span>props <span class="token operator">=</span> <span class="token function">resolveProps</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> matched<span class="token punctuation">.</span>props <span class="token operator">&amp;&amp;</span> matched<span class="token punctuation">.</span>props<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>propsToPass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// clone to prevent mutation</span>
        propsToPass <span class="token operator">=</span> data<span class="token punctuation">.</span>props <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> propsToPass<span class="token punctuation">)</span>
        <span class="token comment">// pass non-declared props as attrs</span>
        <span class="token keyword">const</span> attrs <span class="token operator">=</span> data<span class="token punctuation">.</span>attrs <span class="token operator">=</span> data<span class="token punctuation">.</span>attrs <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> propsToPass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>component<span class="token punctuation">.</span>props <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> component<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            attrs<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> propsToPass<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
            <span class="token keyword">delete</span> propsToPass<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>component<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">resolveProps</span> <span class="token punctuation">(</span><span class="token parameter">route<span class="token punctuation">,</span> config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">'undefined'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span>
      <span class="token keyword">case</span> <span class="token string">'object'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> config
      <span class="token keyword">case</span> <span class="token string">'function'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token function">config</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
      <span class="token keyword">case</span> <span class="token string">'boolean'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> config <span class="token operator">?</span> route<span class="token punctuation">.</span>params <span class="token punctuation">:</span> <span class="token keyword">undefined</span>
      <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">warn</span><span class="token punctuation">(</span>
            <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">props in &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>route<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; is a </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">typeof</span> config<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">expecting an object, function or boolean.</span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>可以看到逻辑还是比较简单的，拿到匹配的组件进行渲染就可以了。</p> <ol start="10"><li>router-link 组件</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// ...</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> createRoute<span class="token punctuation">,</span> isSameRoute<span class="token punctuation">,</span> isIncludedRoute <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/route'</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">'router-link'</span><span class="token punctuation">,</span>
    props<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// 传入的组件属性们</span>
      to<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment">// 目标路由的链接</span>
        type<span class="token punctuation">:</span> toTypes<span class="token punctuation">,</span>
        required<span class="token punctuation">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// 创建的html标签</span>
      tag<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        type<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token string">'a'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// 完整模式，如果为 true 那么也就意味着</span>
      <span class="token comment">// 绝对相等的路由才会增加 activeClass</span>
      <span class="token comment">// 否则是包含关系</span>
      exact<span class="token punctuation">:</span> Boolean<span class="token punctuation">,</span>
      <span class="token comment">// 在当前（相对）路径附加路径</span>
      append<span class="token punctuation">:</span> Boolean<span class="token punctuation">,</span>
      <span class="token comment">// 如果为 true 则调用 router.replace() 做替换历史操作</span>
      replace<span class="token punctuation">:</span> Boolean<span class="token punctuation">,</span>
      <span class="token comment">// 链接激活时使用的 CSS 类名</span>
      activeClass<span class="token punctuation">:</span> String
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">render</span> <span class="token punctuation">(</span><span class="token parameter">h<span class="token punctuation">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 得到 router 实例以及当前激活的 route 对象</span>
      <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$router
      <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$route
      <span class="token keyword">const</span> to <span class="token operator">=</span> <span class="token function">normalizeLocation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>to<span class="token punctuation">,</span> current<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>append<span class="token punctuation">)</span>
      <span class="token comment">// 根据当前目标链接和当前激活的 route匹配结果</span>
      <span class="token keyword">const</span> resolved <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> current<span class="token punctuation">)</span>
      <span class="token keyword">const</span> fullPath <span class="token operator">=</span> resolved<span class="token punctuation">.</span>redirectedFrom <span class="token operator">||</span> resolved<span class="token punctuation">.</span>fullPath
      <span class="token keyword">const</span> base <span class="token operator">=</span> router<span class="token punctuation">.</span>history<span class="token punctuation">.</span>base
      <span class="token comment">// 创建的 href</span>
      <span class="token keyword">const</span> href <span class="token operator">=</span> <span class="token function">createHref</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> fullPath<span class="token punctuation">,</span> router<span class="token punctuation">.</span>mode<span class="token punctuation">)</span>
      <span class="token keyword">const</span> classes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token comment">// 激活class 优先当前组件上获取 要么就是 router 配置的 linkActiveClass</span>
      <span class="token comment">// 默认 router-link-active</span>
      <span class="token keyword">const</span> activeClass <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>activeClass <span class="token operator">||</span> router<span class="token punctuation">.</span>options<span class="token punctuation">.</span>linkActiveClass <span class="token operator">||</span> <span class="token string">'router-link-active'</span>
      <span class="token comment">// 相比较目标</span>
      <span class="token comment">// 因为有命名路由 所有不一定有path</span>
      <span class="token keyword">const</span> compareTarget <span class="token operator">=</span> to<span class="token punctuation">.</span>path <span class="token operator">?</span> <span class="token function">createRoute</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> to<span class="token punctuation">)</span> <span class="token punctuation">:</span> resolved
      <span class="token comment">// 如果严格模式的话 就判断是否是相同路由（path query params hash）</span>
      <span class="token comment">// 否则就走包含逻辑（path包含，query包含 hash为空或者相同）</span>
      classes<span class="token punctuation">[</span>activeClass<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>exact
        <span class="token operator">?</span> <span class="token function">isSameRoute</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> compareTarget<span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token function">isIncludedRoute</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> compareTarget<span class="token punctuation">)</span>
      
      <span class="token comment">// 事件绑定</span>
      <span class="token keyword">const</span> on <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">click</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 忽略带有功能键的点击</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>metaKey <span class="token operator">||</span> e<span class="token punctuation">.</span>ctrlKey <span class="token operator">||</span> e<span class="token punctuation">.</span>shiftKey<span class="token punctuation">)</span> <span class="token keyword">return</span>
          <span class="token comment">// 已阻止的返回</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>defaultPrevented<span class="token punctuation">)</span> <span class="token keyword">return</span>
          <span class="token comment">// 右击</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>button <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
          <span class="token comment">// `target=&quot;_blank&quot;` 忽略</span>
          <span class="token keyword">const</span> target <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'target'</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/\b_blank\b/i</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
          <span class="token comment">// 阻止默认行为 防止跳转</span>
          e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>replace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// replace 逻辑</span>
            router<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// push 逻辑</span>
            router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 创建元素需要附加的数据们</span>
      <span class="token keyword">const</span> data<span class="token punctuation">:</span> any <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token keyword">class</span><span class="token punctuation">:</span> classes
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">.</span>on <span class="token operator">=</span> on
        data<span class="token punctuation">.</span>attrs <span class="token operator">=</span> <span class="token punctuation">{</span> href <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 找到第一个 &lt;a&gt; 给予这个元素事件绑定和href属性</span>
        <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token function">findAnchor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">.</span>default<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// in case the &lt;a&gt; is a static node</span>
          a<span class="token punctuation">.</span>isStatic <span class="token operator">=</span> <span class="token boolean">false</span>
          <span class="token keyword">const</span> extend <span class="token operator">=</span> _Vue<span class="token punctuation">.</span>util<span class="token punctuation">.</span>extend
          <span class="token keyword">const</span> aData <span class="token operator">=</span> a<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
          aData<span class="token punctuation">.</span>on <span class="token operator">=</span> on
          <span class="token keyword">const</span> aAttrs <span class="token operator">=</span> a<span class="token punctuation">.</span>data<span class="token punctuation">.</span>attrs <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>data<span class="token punctuation">.</span>attrs<span class="token punctuation">)</span>
          aAttrs<span class="token punctuation">.</span>href <span class="token operator">=</span> href
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 没有 &lt;a&gt; 的话就给当前元素自身绑定时间</span>
          data<span class="token punctuation">.</span>on <span class="token operator">=</span> on
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 创建元素</span>
      <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tag<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">.</span>default<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">findAnchor</span> <span class="token punctuation">(</span><span class="token parameter">children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> child
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        child <span class="token operator">=</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> child
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>children <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>child <span class="token operator">=</span> <span class="token function">findAnchor</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> child
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">createHref</span> <span class="token punctuation">(</span><span class="token parameter">base<span class="token punctuation">,</span> fullPath<span class="token punctuation">,</span> mode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> path <span class="token operator">=</span> mode <span class="token operator">===</span> <span class="token string">'hash'</span> <span class="token operator">?</span> <span class="token string">'/#'</span> <span class="token operator">+</span> fullPath <span class="token punctuation">:</span> fullPath
    <span class="token keyword">return</span> base <span class="token operator">?</span> <span class="token function">cleanPath</span><span class="token punctuation">(</span>base <span class="token operator">+</span> path<span class="token punctuation">)</span> <span class="token punctuation">:</span> path
  <span class="token punctuation">}</span>
</code></pre></div><p>可以看出 <code>router-link</code> 组件就是在其点击的时候根据设置的 <code>to</code> 的值去调用 <code>router</code> 的 <code>push</code> 或者 <code>replace</code> 来更新路由的，同时呢，会检查自身是否和当前路由匹配（严格匹配和包含匹配）来决定自身的 <code>activeClass</code> 是否添加。
<img src="/assets/img/vue-router-strem.61276826.png" alt="vue-router整体流程"></p> <ol start="11"><li>hash 路由监听和跳转的实现</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">/* @flow */</span>

  <span class="token keyword">import</span> type Router <span class="token keyword">from</span> <span class="token string">'../index'</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> History <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./base'</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> cleanPath <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/path'</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> getLocation <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./html5'</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> setupScroll<span class="token punctuation">,</span> handleScroll <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/scroll'</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> pushState<span class="token punctuation">,</span> replaceState<span class="token punctuation">,</span> supportsPushState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/push-state'</span>

  <span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HashHistory</span> <span class="token keyword">extends</span> <span class="token class-name">History</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">router<span class="token punctuation">:</span> Router<span class="token punctuation">,</span> base<span class="token punctuation">:</span> <span class="token operator">?</span>string<span class="token punctuation">,</span> fallback<span class="token punctuation">:</span> boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span>router<span class="token punctuation">,</span> base<span class="token punctuation">)</span>
      <span class="token comment">// 是否是History模式，如果不支持History退回到hash模式</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>fallback <span class="token operator">&amp;&amp;</span> <span class="token function">checkFallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      <span class="token function">ensureSlash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//  监听hash路由的变化。避免监听的过早，执行两次，在初始化的时候只执行一次</span>
    <span class="token function">setupListeners</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>router
      <span class="token comment">// 获取路由滚动行为</span>
      <span class="token keyword">const</span> expectScroll <span class="token operator">=</span> router<span class="token punctuation">.</span>options<span class="token punctuation">.</span>scrollBehavior
      <span class="token comment">// 是否支持pushState，并且有滚动行为</span>
      <span class="token keyword">const</span> supportsScroll <span class="token operator">=</span> supportsPushState <span class="token operator">&amp;&amp;</span> expectScroll

      <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsScroll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setupScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 支持pushstate 则使用popstate监听，否则使用hashchange监听</span>
      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
        supportsPushState <span class="token operator">?</span> <span class="token string">'popstate'</span> <span class="token punctuation">:</span> <span class="token string">'hashchange'</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current
          <span class="token comment">// 路由不正确，不会更新路由</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ensureSlash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// 监听回调，当路由改变，更新当前路由对象，并改变当前路由</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span><span class="token function">getHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsScroll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">handleScroll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">,</span> route<span class="token punctuation">,</span> current<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>supportsPushState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">replaceHash</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>fullPath<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 实现父类的push方法，hash使用的是pushState（因为要支持滚动行为）和location.hash = path</span>
    <span class="token comment">// onComplete是跳转完成的回调函数，参数是当前路由对象实例</span>
    <span class="token function">push</span> <span class="token punctuation">(</span><span class="token parameter">location<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token punctuation">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> current<span class="token punctuation">:</span> fromRoute <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>
        location<span class="token punctuation">,</span>
        <span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 使用pushState切换路由</span>
          <span class="token function">pushHash</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>fullPath<span class="token punctuation">)</span>
          <span class="token function">handleScroll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">,</span> route<span class="token punctuation">,</span> fromRoute<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
          onComplete <span class="token operator">&amp;&amp;</span> <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        onAbort
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 实现父类的replace方法，replace使用的是replaceState（因为要支持滚动行为）和location.replace()</span>
    <span class="token function">replace</span> <span class="token punctuation">(</span><span class="token parameter">location<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token punctuation">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> current<span class="token punctuation">:</span> fromRoute <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>
        location<span class="token punctuation">,</span>
        <span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">replaceHash</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>fullPath<span class="token punctuation">)</span>
          <span class="token function">handleScroll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">,</span> route<span class="token punctuation">,</span> fromRoute<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
          onComplete <span class="token operator">&amp;&amp;</span> <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        onAbort
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 直接使用history的跳转页面</span>
    <span class="token function">go</span> <span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">ensureURL</span> <span class="token punctuation">(</span><span class="token parameter">push<span class="token operator">?</span><span class="token punctuation">:</span> boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>fullPath
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!==</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        push <span class="token operator">?</span> <span class="token function">pushHash</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">replaceHash</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 获取当前页面hash</span>
    <span class="token function">getCurrentLocation</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">getHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">checkFallback</span> <span class="token punctuation">(</span><span class="token parameter">base</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token function">getLocation</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex">/^\/#/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">cleanPath</span><span class="token punctuation">(</span>base <span class="token operator">+</span> <span class="token string">'/#'</span> <span class="token operator">+</span> location<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">ensureSlash</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> boolean <span class="token punctuation">{</span>
    <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">getHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
    <span class="token function">replaceHash</span><span class="token punctuation">(</span><span class="token string">'/'</span> <span class="token operator">+</span> path<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getHash</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> string <span class="token punctuation">{</span>
    <span class="token keyword">let</span> href <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href
    <span class="token keyword">const</span> index <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">''</span>

    href <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> searchIndex <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>searchIndex <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> hashIndex <span class="token operator">=</span> href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hashIndex <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        href <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span>href<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> hashIndex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> href<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>hashIndex<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> href <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span>href<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>searchIndex <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        href <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span>href<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> searchIndex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> href<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>searchIndex<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> href
  <span class="token punctuation">}</span>
  <span class="token comment">// 页面跳转的方法实现，区分了是否支持pushstate情况</span>
  <span class="token keyword">function</span> <span class="token function">pushHash</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsPushState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">pushState</span><span class="token punctuation">(</span><span class="token function">getUrl</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash <span class="token operator">=</span> path
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">replaceHash</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsPushState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">replaceState</span><span class="token punctuation">(</span><span class="token function">getUrl</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">getUrl</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>通过<code>hash</code>模式的代码我们看到，通过<code>hash</code>路由跳转，首先判断是否是合法的路径和 <code>hash</code>，还有就是路由是否发生变化。然后，实现父类的跳转方法，因为要支持页面滚动行为，所以<code>push</code>就区分了<code>pushState</code>和<code>location.hash</code>两种跳转方式。<code>replace</code>区分了<code>replaceState</code>和<code>location.replace</code>两种方式，<code>go</code>方法统一使用<code>history.go</code>方法。跳转完成后可以传递完成后的回调函数。</p> <ol start="12"><li>History 路由监听和跳转的实现</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">/* @flow */</span>

  <span class="token keyword">import</span> type Router <span class="token keyword">from</span> <span class="token string">'../index'</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> History <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./base'</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> cleanPath <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/path'</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">START</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/route'</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> setupScroll<span class="token punctuation">,</span> handleScroll <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/scroll'</span>
  <span class="token keyword">import</span> <span class="token punctuation">{</span> pushState<span class="token punctuation">,</span> replaceState<span class="token punctuation">,</span> supportsPushState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/push-state'</span>

  <span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HTML5History</span> <span class="token keyword">extends</span> <span class="token class-name">History</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">router<span class="token punctuation">:</span> Router<span class="token punctuation">,</span> base<span class="token punctuation">:</span> <span class="token operator">?</span>string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span>router<span class="token punctuation">,</span> base<span class="token punctuation">)</span>

      <span class="token keyword">const</span> expectScroll <span class="token operator">=</span> router<span class="token punctuation">.</span>options<span class="token punctuation">.</span>scrollBehavior
      <span class="token keyword">const</span> supportsScroll <span class="token operator">=</span> supportsPushState <span class="token operator">&amp;&amp;</span> expectScroll

      <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsScroll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setupScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">const</span> initLocation <span class="token operator">=</span> <span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>base<span class="token punctuation">)</span>
      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'popstate'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current
        <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>base<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">===</span> <span class="token constant">START</span> <span class="token operator">&amp;&amp;</span> location <span class="token operator">===</span> initLocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> <span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsScroll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">handleScroll</span><span class="token punctuation">(</span>router<span class="token punctuation">,</span> route<span class="token punctuation">,</span> current<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">go</span> <span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">push</span> <span class="token punctuation">(</span><span class="token parameter">location<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token punctuation">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> current<span class="token punctuation">:</span> fromRoute <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> <span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">pushState</span><span class="token punctuation">(</span><span class="token function">cleanPath</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>base <span class="token operator">+</span> route<span class="token punctuation">.</span>fullPath<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">handleScroll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">,</span> route<span class="token punctuation">,</span> fromRoute<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        onComplete <span class="token operator">&amp;&amp;</span> <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> onAbort<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">replace</span> <span class="token punctuation">(</span><span class="token parameter">location<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token punctuation">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> current<span class="token punctuation">:</span> fromRoute <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> <span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">replaceState</span><span class="token punctuation">(</span><span class="token function">cleanPath</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>base <span class="token operator">+</span> route<span class="token punctuation">.</span>fullPath<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">handleScroll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">,</span> route<span class="token punctuation">,</span> fromRoute<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        onComplete <span class="token operator">&amp;&amp;</span> <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> onAbort<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">ensureURL</span> <span class="token punctuation">(</span><span class="token parameter">push<span class="token operator">?</span><span class="token punctuation">:</span> boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>base<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>fullPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token function">cleanPath</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>base <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>fullPath<span class="token punctuation">)</span>
        push <span class="token operator">?</span> <span class="token function">pushState</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">replaceState</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">getCurrentLocation</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> string <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>base<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getLocation</span> <span class="token punctuation">(</span><span class="token parameter">base<span class="token punctuation">:</span> string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> string <span class="token punctuation">{</span>
    <span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>pathname<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>base <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      path <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>path <span class="token operator">||</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token operator">+</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>search <span class="token operator">+</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash
  <span class="token punctuation">}</span>
</code></pre></div><p>相对<code>hash</code>模式，<code>history</code>模式实现更为简单。首先看是否传入路由滚动行为函数，有的话，后面需要执行。然后下一步直接监听<code>popstate</code>，执行回调函数，有滚动行为就执行，没有就不执行，最后实现了父类的<code>push</code>、<code>replace</code>、<code>go</code>方法，这个比较简单，直接就使用了<code>pushState</code>和<code>replaceState</code>进行路由跳转。（但是我们看代码，<code>history</code>和<code>hash</code>跳转执行的是同一个方法，这是为了代码公用，在公共方法中使用了<code>ry...catch</code>进行了拦截，如果支持<code>history</code>就不会进入<code>catch</code>分支了，有兴趣可以详细查看代码<code>utils/push-state.js</code>）<br><br>
下来我们对比一下hash和history两种模式：<br></p> <ul><li><p><code>hash</code>模式相比<code>history</code>比较丑陋，因为有一个<code>#</code>号<br></p></li> <li><p><code>pushState</code>设置的新<code>URL</code>可以是与当前URL同源的任意<code>URL</code>；而<code>hash</code>只可修改<code>#</code>后面的部分，故只可设置与当前同文档的<code>URL</code><br></p></li> <li><p><code>pushState</code>设置的新<code>URL</code>可以与当前<code>URL</code>一模一样，这样也会把记录添加到栈中；而<code>hash</code>设置的新值必须与原来不一样才会触发记录添加到栈中<br></p></li> <li><p><code>pushState</code>通过<code>stateObject</code>状态对象可以添加任意类型的数据到记录中；而<code>hash</code>只可添加短字符串<br></p></li> <li><p>history的使用，需要服务器的支持，因为当浏览器修改url后（http://baidu.com =&gt; http://baidu/error）必然触发浏览器向后台重新请求（请求document 页面），但是后台没有配置该路由，就会返回404，所以就需要解决这个问题。这个问题的解决方式就是：在服务器匹配所有的url将它重定向到baseurl（baseurl会返回index.html）</p> <div class="language-bash extra-class"><pre class="language-bash"><code>  // apache
  <span class="token operator">&lt;</span>IfModule mod_rewrite.c<span class="token operator">&gt;</span>
    RewriteEngine On
    RewriteBase /
    RewriteRule ^index<span class="token punctuation">\</span>.html$ - <span class="token punctuation">[</span>L<span class="token punctuation">]</span>
    RewriteCond %<span class="token punctuation">{</span>REQUEST_FILENAME<span class="token punctuation">}</span> <span class="token operator">!</span>-f
    RewriteCond %<span class="token punctuation">{</span>REQUEST_FILENAME<span class="token punctuation">}</span> <span class="token operator">!</span>-d
    RewriteRule <span class="token builtin class-name">.</span> /index.html <span class="token punctuation">[</span>L<span class="token punctuation">]</span>
  <span class="token operator">&lt;</span>/IfModule<span class="token operator">&gt;</span>

  // nginx
  location / <span class="token punctuation">{</span>
    // 按顺序检查<span class="token variable">$uri</span>文件是否存在，返回第一个找到的文件或文件夹<span class="token punctuation">(</span>结尾加斜线表示为文件夹<span class="token punctuation">)</span>，如果所有的文件或文件夹都找不到，会进行一个内部重定向到最后一个参数/index.html。
    try_files <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ /index.html
  <span class="token punctuation">}</span>

  //node.js
  const http <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
  const fs <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
  const httpPort <span class="token operator">=</span> <span class="token number">80</span>

  http.createServer<span class="token punctuation">((</span>req, res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    fs.readFile<span class="token punctuation">(</span><span class="token string">'index.htm'</span>, <span class="token string">'utf-8'</span>, <span class="token punctuation">(</span>err, content<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console.log<span class="token punctuation">(</span><span class="token string">'We cannot open &quot;index.htm&quot; file.'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      res.writeHead<span class="token punctuation">(</span><span class="token number">200</span>, <span class="token punctuation">{</span>
        <span class="token string">'Content-Type'</span><span class="token builtin class-name">:</span> <span class="token string">'text/html; charset=utf-8'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      res.end<span class="token punctuation">(</span>content<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>.listen<span class="token punctuation">(</span>httpPort, <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    console.log<span class="token punctuation">(</span><span class="token string">'Server listening on: http://localhost:%s'</span>, httpPort<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ul> <h2 id="react-router的路由实现以及源码分析"><a href="#react-router的路由实现以及源码分析" aria-hidden="true" class="header-anchor">#</a> React-Router的路由实现以及源码分析</h2> <h3 id="实现原理-2"><a href="#实现原理-2" aria-hidden="true" class="header-anchor">#</a> 实现原理</h3> <h3 id="源码分析-2"><a href="#源码分析-2" aria-hidden="true" class="header-anchor">#</a> 源码分析</h3></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.85ad02d9.js" defer></script><script src="/assets/js/2.4db6f8f6.js" defer></script><script src="/assets/js/6.38fe2a42.js" defer></script>
  </body>
</html>
